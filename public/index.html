<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GMB Review Response Agent - Admin Dashboard</title>
    <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

      body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f7fa;
      color: #333;
      line-height: 1.6;
      display: flex;
      margin: 0;
      padding: 0;
    }

    /* Sidebar Navigation */
    .sidebar {
      width: 260px;
      background: #1a1d29;
      color: #e0e0e0;
      height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      overflow-y: auto;
      z-index: 100;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      background: #151720;
    }

    .sidebar-header h2 {
      color: white;
      font-size: 1.3rem;
      font-weight: 700;
      margin: 0;
    }

    .sidebar-nav {
      padding: 10px 0;
    }

    .nav-item {
      position: relative;
    }

    .nav-item > .nav-link {
        display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      color: #e0e0e0;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.2s ease;
      border-left: 3px solid transparent;
    }

    .nav-item > .nav-link:hover {
      background: rgba(255,255,255,0.05);
      color: white;
    }

    .nav-item > .nav-link.active {
      background: rgba(102, 126, 234, 0.15);
      color: #667eea;
      border-left-color: #667eea;
      font-weight: 600;
    }

    .nav-item > .nav-link .nav-icon {
      margin-right: 12px;
      font-size: 1.1rem;
    }

    .nav-item > .nav-link .nav-arrow {
      font-size: 0.8rem;
      opacity: 0.6;
      transition: transform 0.2s ease;
    }

    .nav-item.expanded > .nav-link .nav-arrow {
      transform: rotate(90deg);
    }

    .nav-submenu {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      background: rgba(0,0,0,0.2);
    }

    .nav-item.expanded > .nav-submenu {
      max-height: 1000px;
    }

    .nav-submenu .nav-link {
      display: flex;
      align-items: center;
      padding: 10px 20px 10px 50px;
      color: #b0b0b0;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.2s ease;
      border-left: 3px solid transparent;
      font-size: 0.9rem;
    }

    .nav-submenu .nav-link:hover {
      background: rgba(255,255,255,0.05);
      color: white;
    }

    .nav-submenu .nav-link.active {
      background: rgba(102, 126, 234, 0.15);
      color: #667eea;
      border-left-color: #667eea;
      font-weight: 600;
    }

    .nav-submenu .nav-link .nav-icon {
      margin-right: 10px;
      font-size: 1rem;
    }

    /* Main Content Area */
    .main-content {
      flex: 1;
      margin-left: 260px;
      min-height: 100vh;
      background: #f5f7fa;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

      header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px 0;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        width: 100%;
    }

    .header-inner {
        display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .header-left {
      min-width: 0;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
      position: relative;
    }

    .biz-switcher {
      display: none;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border: 1px solid rgba(255,255,255,0.25);
      background: rgba(255,255,255,0.12);
      color: white;
      border-radius: 999px;
    }

    .biz-switcher select {
      background: transparent;
      border: none;
      color: white;
      font-weight: 700;
      outline: none;
      cursor: pointer;
      max-width: 240px;
    }

    .biz-switcher select option {
      color: #111;
    }

    .profile-btn {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border: 1px solid rgba(255,255,255,0.25);
      background: rgba(255,255,255,0.12);
      color: white;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s ease;
      user-select: none;
    }

    .profile-btn:hover {
      background: rgba(255,255,255,0.18);
    }

    .profile-avatar {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      background: rgba(255,255,255,0.25);
      display: grid;
      place-items: center;
      font-weight: 700;
      letter-spacing: 0.5px;
    }

    .profile-dropdown {
      position: absolute;
      top: 52px;
      right: 0;
      width: 260px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.2);
      border: 1px solid rgba(0,0,0,0.08);
      overflow: hidden;
      display: none;
      z-index: 50;
    }

    .profile-dropdown.open {
      display: block;
    }

    .profile-dropdown .pd-header {
      padding: 14px 16px;
        border-bottom: 1px solid #eee;
      color: #333;
    }

    .profile-dropdown .pd-header .pd-email {
      font-size: 0.9rem;
      color: #666;
      margin-top: 4px;
      word-break: break-all;
    }

    .profile-dropdown button {
      width: 100%;
        text-align: left;
      padding: 12px 16px;
      border: none;
      background: white;
      cursor: pointer;
      font-weight: 600;
      color: #333;
    }

    .profile-dropdown button:hover {
      background: #f6f7fb;
    }

    .profile-dropdown .danger {
      color: #b42318;
    }

    header h1 {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    header p {
      opacity: 0.9;
    }

    /* Tabs removed - using sidebar navigation instead */

    .tab-content {
      display: none;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .tab-content.active {
      display: block;
    }

    .section-title {
      font-size: 1.5rem;
      margin-bottom: 20px;
      color: #333;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
    }

    .card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .btn {
      padding: 12px 24px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
        cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.3s;
      margin-right: 10px;
      margin-bottom: 10px;
    }

    .btn:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .btn-secondary {
      background: #6c757d;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .btn-success {
      background: #28a745;
    }

    .btn-success:hover {
      background: #218838;
    }

    .btn-danger {
      background: #dc3545;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #555;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-group textarea {
        min-height: 120px;
      resize: vertical;
    }

    .review-item {
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      transition: all 0.3s;
    }

    .review-item:hover {
      border-color: #667eea;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .review-author {
      font-weight: 600;
      font-size: 1.1rem;
      color: #333;
    }

    .review-rating {
      display: flex;
      gap: 5px;
    }

    .star {
      color: #ffc107;
      font-size: 1.2rem;
    }

    .star.empty {
      color: #e0e0e0;
    }

    .review-date {
      color: #666;
      font-size: 0.9rem;
    }

    .review-comment {
      margin: 15px 0;
      color: #555;
      line-height: 1.6;
    }

    .review-analysis {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      margin-top: 15px;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
        border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 500;
        margin-right: 8px;
      margin-bottom: 8px;
    }

    .badge-success {
      background: #d4edda;
      color: #155724;
    }

    .badge-warning {
      background: #fff3cd;
      color: #856404;
    }

    .badge-danger {
      background: #f8d7da;
      color: #721c24;
    }

    .badge-info {
      background: #d1ecf1;
      color: #0c5460;
    }

    .badge-primary {
      background: #cfe2ff;
      color: #084298;
    }

    .reply-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid #e0e0e0;
    }

    .reply-draft {
      background: #e7f3ff;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 15px;
      border-left: 4px solid #667eea;
    }

    .loading {
        display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-card h3 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .stat-card p {
      opacity: 0.9;
      font-size: 1.1rem;
    }

    .filter-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .filter-row {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: flex-end;
    }

    .filter-row .form-group {
      flex: 1;
      min-width: 200px;
      margin-bottom: 0;
    }

    .keyword-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .keyword-item {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      border-left: 4px solid #667eea;
    }

    .keyword-item strong {
      display: block;
      margin-bottom: 8px;
      color: #333;
    }

    .keyword-item span {
      color: #666;
      font-size: 0.9rem;
    }

    .analysis-result {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 8px;
      margin-top: 20px;
    }

    .recommendation-item {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 4px solid #667eea;
    }

    .recommendation-item.high {
      border-left-color: #dc3545;
    }

    .recommendation-item.medium {
      border-left-color: #ffc107;
    }

    .recommendation-item.low {
      border-left-color: #28a745;
    }

    .recommendation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .recommendation-title {
        font-weight: 600;
      font-size: 1.1rem;
      color: #333;
    }

    .action-items {
      margin-top: 15px;
      padding-left: 20px;
    }

    .action-items li {
      margin-bottom: 8px;
      color: #555;
    }

    .alert {
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      border-left: 4px solid;
    }

    .alert-success {
      background: #d4edda;
      border-color: #28a745;
      color: #155724;
    }

    .alert-error {
      background: #f8d7da;
      border-color: #dc3545;
      color: #721c24;
    }

    .alert-info {
      background: #d1ecf1;
      border-color: #17a2b8;
      color: #0c5460;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .empty-state svg {
      width: 100px;
      height: 100px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .score-circle {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      font-weight: bold;
      margin: 0 auto 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    /* Notification/Toast System */
    .notification-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 400px;
    }

    .notification {
      background: white;
      border-radius: 8px;
      padding: 16px 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: flex-start;
      gap: 12px;
      animation: slideIn 0.3s ease-out;
      border-left: 4px solid;
      min-width: 300px;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    .notification.slide-out {
      animation: slideOut 0.3s ease-out forwards;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
      }
      to {
        opacity: 0;
      }
    }

    @keyframes modalSlideIn {
      from {
        transform: translate(-50%, -60%);
        opacity: 0;
      }
      to {
        transform: translate(-50%, -50%);
        opacity: 1;
      }
    }

    @keyframes modalSlideOut {
      from {
        transform: translate(-50%, -50%);
        opacity: 1;
      }
      to {
        transform: translate(-50%, -60%);
        opacity: 0;
      }
    }

    .notification-success {
      border-left-color: #28a745;
    }

    .notification-error {
      border-left-color: #dc3545;
    }

    .notification-info {
      border-left-color: #17a2b8;
    }

    .notification-warning {
      border-left-color: #ffc107;
    }

    .notification-icon {
      font-size: 1.5rem;
      flex-shrink: 0;
    }

    .notification-content {
      flex: 1;
    }

    .notification-title {
      font-weight: 600;
      margin-bottom: 4px;
      color: #333;
    }

    .notification-message {
      color: #666;
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .notification-close {
      background: none;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      color: #999;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .notification-close:hover {
      background: #f0f0f0;
      color: #333;
    }

    .btn-sm {
      font-size: 0.875rem;
      padding: 6px 12px;
      }

    /* Bulk actions toolbar */
    .bulk-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #e0e0e0;
      background: #ffffff;
      margin-top: 12px;
      margin-bottom: 12px;
    }
    .bulk-left {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .bulk-right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .small-muted {
      color: #777;
      font-size: 0.9rem;
    }
    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .diff-pre {
      margin: 0;
      padding: 12px;
      background: #0b1020;
      color: #e7e7e7;
      border-radius: 10px;
      overflow: auto;
      max-height: 55vh;
      font-size: 0.9rem;
      line-height: 1.4;
      white-space: pre;
    }
    .diff-line {
      display: block;
      padding: 2px 6px;
      border-radius: 6px;
    }
    .diff-add {
      background: rgba(46, 204, 113, 0.18);
    }
    .diff-del {
      background: rgba(231, 76, 60, 0.18);
    }
    .diff-same {
      opacity: 0.9;
      }
    </style>
  </head>
  <body>
  <!-- Notification Container -->
  <div class="notification-container" id="notificationContainer"></div>
  
  <!-- Sidebar Navigation -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h2>BusinessAI Suite</h2>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-item expanded" id="gmbNavItem">
        <div class="nav-link" onclick="toggleNavItem('gmbNavItem')">
          <span>
            <span class="nav-icon">üè¢</span>
            Google My Business
          </span>
          <span class="nav-arrow">‚ñ∂</span>
        </div>
        <div class="nav-submenu">
          <a class="nav-link active" onclick="showTab('reviews', event)" data-tab="reviews">
            <span class="nav-icon">üìù</span>
            Reviews
          </a>
          <a class="nav-link" onclick="showTab('posts', event)" data-tab="posts">
            <span class="nav-icon">üìÑ</span>
            GMB Posts
          </a>
          <a class="nav-link" onclick="showTab('trends', event)" data-tab="trends">
            <span class="nav-icon">üìä</span>
            Keyword Trends
          </a>
          <a class="nav-link" onclick="showTab('analyzer', event)" data-tab="analyzer">
            <span class="nav-icon">üîç</span>
            Profile Analyzer
          </a>
        </div>
      </div>
      <!-- Competitive Insights as separate top-level menu -->
      <div class="nav-item">
        <a class="nav-link" onclick="showTab('competitive', event)" data-tab="competitive">
          <span>
            <span class="nav-icon">üèÅ</span>
            Competitive Insights
          </span>
        </a>
      </div>
      <!-- Campaigns as separate top-level menu -->
      <div class="nav-item expanded" id="campaignsNavItem">
        <div class="nav-link" onclick="toggleNavItem('campaignsNavItem')">
          <span>
            <span class="nav-icon">üìà</span>
            Campaigns
          </span>
          <span class="nav-arrow">‚ñ∂</span>
        </div>
        <div class="nav-submenu">
          <a class="nav-link" onclick="showTab('campaigns', event)" data-tab="campaigns">
            <span class="nav-icon">üó∫Ô∏è</span>
            Geographic Keyword Analysis
          </a>
        </div>
      </div>
      <!-- Future tools can be added here -->
    </nav>
  </aside>

  <!-- Main Content Area -->
  <div class="main-content">
    <header>
      <div class="container header-inner">
        <div class="header-left">
          <h1>ü¶∑ BusinessAI Suite</h1>
          <p><span id="headerBusinessName">Malama Dental</span> - Admin Dashboard</p>
        </div>

        <div class="header-right">
          <div class="biz-switcher" id="bizSwitcherWrap" title="Active Business">
            <span style="opacity:0.9; font-weight:800;">üè¢</span>
            <select id="bizSwitcher" onchange="switchBusiness(event)"></select>
          </div>
          <div class="profile-menu">
            <div class="profile-btn" id="profileBtn" onclick="toggleProfileMenu()">
              <div class="profile-avatar" id="profileAvatar">U</div>
              <div style="display:flex; flex-direction:column; line-height:1.1;">
                <div style="font-size:0.9rem;" id="profileName">User</div>
                <div style="font-size:0.8rem; opacity:0.85;" id="profileEmail"> </div>
              </div>
              <div style="opacity:0.9;">‚ñæ</div>
            </div>

            <div class="profile-dropdown" id="profileDropdown">
              <div class="pd-header">
                <div style="font-weight:800;" id="pdName">Signed in</div>
                <div class="pd-email" id="pdEmail"></div>
              </div>
              <button id="teamProfileBtn" style="display:none" onclick="showTab('team', event)">üë• Team</button>
              <button onclick="openSettings()">‚öôÔ∏è Settings</button>
              <button class="danger" onclick="doLogout()">üö™ Logout</button>
            </div>
          </div>
        </div>
      </div>
    </header>

  <div class="container">
    <!-- Stats Overview - Only shown on Reviews page -->
    <div class="stats-grid" id="statsGrid" style="display: none;">
      <div class="stat-card">
        <h3 id="totalReviews">-</h3>
        <p>Total Reviews</p>
      </div>
      <div class="stat-card">
        <h3 id="averageRating">-</h3>
        <p>Average Rating</p>
      </div>
      <div class="stat-card">
        <h3 id="replyRate">-</h3>
        <p>Reply Rate</p>
      </div>
      <div class="stat-card">
        <h3 id="unrepliedCount">-</h3>
        <p>Unreplied Reviews</p>
      </div>
    </div>

    <!-- Tabs removed - now using sidebar navigation -->

    <!-- Reviews Tab -->
    <div id="reviews" class="tab-content active">
      <h2 class="section-title">Review Analysis & Management</h2>
      
      <div class="filter-section">
        <div class="filter-row">
          <div class="form-group">
            <label>Filter by Status</label>
            <select id="filterStatus" onchange="loadReviews()">
              <option value="">All Status</option>
          <option value="Needs Approval">Needs Approval</option>
          <option value="Auto-Approved">Auto-Approved</option>
              <option value="Replied">Replied</option>
        </select>
          </div>
          <div class="form-group">
            <label>Filter by Rating</label>
            <select id="filterRating" onchange="loadReviews()">
              <option value="">All Ratings</option>
              <option value="5">5 Stars</option>
              <option value="4">4 Stars</option>
              <option value="3">3 Stars</option>
              <option value="2">2 Stars</option>
              <option value="1">1 Star</option>
        </select>
          </div>
          <div class="form-group">
            <label>Filter by Sentiment</label>
            <select id="filterSentiment" onchange="loadReviews()">
              <option value="">All Sentiments</option>
          <option value="positive">Positive</option>
          <option value="neutral">Neutral</option>
          <option value="negative">Negative</option>
        </select>
          </div>
          <div class="form-group">
            <button class="btn" onclick="loadReviews()">üîÑ Refresh</button>
            <button class="btn btn-success" onclick="fetchNewReviews(event)">üì• Fetch New Reviews</button>
            <button class="btn btn-secondary" onclick="analyzeAllUnreplied()">ü§ñ Analyze All Unreplied</button>
            <button class="btn btn-secondary" onclick="autoReplyUnreplied()">‚ö° Auto-Reply Approved</button>
          </div>
        </div>
      </div>

      <div class="bulk-toolbar" id="bulkToolbar" style="display:none;">
        <div class="bulk-left">
          <label class="small-muted" style="display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="selectAllVisible" onchange="toggleSelectAllVisible(this.checked)" />
            Select all visible
      </label>
          <span class="small-muted">Selected: <strong id="selectedCount">0</strong></span>
          <span class="small-muted" id="overdueApprovals"></span>
          <button class="btn btn-secondary btn-sm" onclick="clearSelection()">Clear</button>
        </div>
        <div class="bulk-right">
          <button class="btn btn-secondary btn-sm" onclick="bulkCopyDrafts()">üìã Copy Drafts</button>
          <button class="btn btn-success btn-sm" onclick="bulkApproveAndPost()">‚úÖ Bulk Approve & Post</button>
        </div>
      </div>

      <div class="card" style="margin-top: 20px; background: #f8f9fa; border: 1px solid #e0e0e0;">
        <h3 style="margin-top: 0; color: #333;">üîó Google Business Profile Connection</h3>
        <p style="color: #666; margin-bottom: 15px;">
          Connect your Google Business Profile to enable automatic review fetching and replies.
        </p>
        <div id="googleConnectionStatus" style="margin-bottom: 15px;">
          <span class="badge badge-warning">Checking connection...</span>
        </div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <!-- Use an anchor so the flow works even if JS has runtime errors -->
          <a class="btn btn-success" href="/api/auth/google/connect" id="connectGoogleBtn" style="text-decoration: none; display: inline-flex; align-items: center;">
            üîó Connect Google Business Profile
          </a>
          <button class="btn btn-secondary" onclick="disconnectGoogle()" id="disconnectGoogleBtn" style="display: none;">
            ‚ùå Disconnect
          </button>
        </div>
      </div>

      <div id="reviewsList"></div>
    </div>

    <!-- Posts Tab -->
    <div id="posts" class="tab-content">
      <h2 class="section-title">Google My Business Posts</h2>
      
      <div class="card">
        <h3>Create New Post</h3>
        <div class="form-group">
          <label>Post Type</label>
          <select id="postType">
            <option value="STANDARD">Standard</option>
            <option value="EVENT">Event</option>
            <option value="OFFER">Offer</option>
            <option value="ALERT">Alert</option>
        </select>
        </div>
        <div class="form-group">
          <label>Call-to-Action</label>
          <select id="postCTA">
            <option value="LEARN_MORE">Learn More</option>
            <option value="CALL">Call</option>
            <option value="BOOK">Book</option>
            <option value="SHOP">Shop</option>
            <option value="SIGN_UP">Sign Up</option>
        </select>
        </div>
        <div class="form-group">
          <label>Topic (Optional - leave empty to use weekly report keywords)</label>
          <input type="text" id="postTopic" placeholder="e.g., Dental cleaning tips">
        </div>
        <button class="btn" onclick="generatePost()">üé® Generate Post</button>
        <button class="btn btn-secondary" onclick="listPosts()">üìã List Posts</button>
    </div>

      <div id="postPreview" style="display: none;">
        <div class="card">
          <h3>Post Preview</h3>
          <div id="postContent"></div>
          <div class="reply-draft" id="postImageInfo"></div>
          <button class="btn btn-success" onclick="confirmPost()">‚úÖ Post to GMB</button>
          <button class="btn btn-secondary" onclick="cancelPost()">‚ùå Cancel</button>
        </div>
      </div>

      <div id="postsList"></div>
    </div>

    <!-- Trends Tab -->
    <div id="trends" class="tab-content">
      <h2 class="section-title">Keyword Trends Analysis</h2>
      
      <div class="card">
        <h3>Research Keywords for Location</h3>
        <div class="form-group">
          <label>Location (City, State)</label>
          <input type="text" id="trendLocation" placeholder="e.g., Long Valley, NJ" value="Long Valley, NJ">
        </div>
        <div class="form-group">
          <label>Radius (miles)</label>
          <input type="number" id="trendRadius" value="10" min="1" max="50">
        </div>
        <div class="form-group">
          <label>Business Name (for GBP rank comparison)</label>
          <input type="text" id="rankingBusinessName" placeholder="e.g., Malama Dental">
        </div>
        <div class="form-group">
          <label>Website Domain (for organic rank comparison)</label>
          <input type="text" id="rankingWebsiteDomain" placeholder="e.g., malama.dental">
        </div>
        <div class="form-group">
          <label style="display:flex; align-items:center; gap:10px;">
            <input type="checkbox" id="useSerpApiRankings" />
            Include GBP + website rankings (uses SerpAPI credits)
      </label>
          <small style="color:#777;">If unchecked, we‚Äôll only use Google Trends keyword generation without ranking lookups.</small>
        </div>
        <button class="btn" onclick="researchKeywords()">üîç Research Keywords</button>
    </div>

      <div class="card">
        <h3>Weekly Keyword Report</h3>
        <div class="form-group">
          <label>Generate report for all locations or specific location</label>
          <input type="text" id="reportLocation" placeholder="Leave empty for all locations">
        </div>
        <button class="btn" onclick="generateWeeklyReport()">üìä Generate Weekly Report</button>
        <button class="btn btn-secondary" onclick="viewTrends()">üìà View Saved Trends</button>
      </div>

      <div id="trendsResults"></div>
      </div>

    <!-- Competitive Tab -->
    <div id="competitive" class="tab-content">
      <h2 class="section-title">Competitive Insights</h2>

      <div class="card">
        <h3 style="margin-top:0;">Discover competitors (Places API)</h3>
        <div class="filter-row">
          <div class="form-group">
            <label>Query</label>
            <input type="text" id="compQuery" placeholder="e.g., general dentist near me" value="general dentist" />
          </div>
          <div class="form-group">
            <label>Radius (miles)</label>
            <input type="number" id="compRadius" min="1" max="50" value="10" />
          </div>
          <div class="form-group">
            <label>Limit</label>
            <input type="number" id="compLimit" min="1" max="20" value="10" />
          </div>
          <div class="form-group">
            <button class="btn" onclick="discoverCompetitorsUi(event)">üîé Discover</button>
            <button class="btn btn-secondary" onclick="refreshCompetitorsUi(event)">‚ôªÔ∏è Refresh snapshots</button>
            <button class="btn btn-secondary" onclick="refreshCompetitorCoordinates(event)">üìç Refresh coordinates</button>
          </div>
        </div>
        <div class="small-muted" style="margin-top:8px;">
          Requires <span class="mono">GOOGLE_PLACES_API_KEY</span>. Discovery uses your GBP location as a bias when available.
        </div>
      </div>

      <div class="card" id="competitiveSplitView" style="display: flex; gap: 20px; padding: 0;">
        <div style="flex: 1; padding: 20px; border-right: 1px solid #e5e7eb;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin-top:0; margin-bottom: 0;">Map View</h3>
            <button class="btn btn-secondary btn-sm" onclick="discoverCommunityPoints()" style="font-size: 0.85em;">
              üîç Discover Community
            </button>
          </div>
          
          <!-- Layer Control Panel -->
          <div id="mapLayerControls" style="background: #f9fafb; padding: 12px; border-radius: 6px; margin-bottom: 12px; border: 1px solid #e5e7eb;">
            <div style="font-weight: 600; font-size: 0.9em; margin-bottom: 8px; color: #374151;">Map Layers</div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 0.85em;">
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <input type="checkbox" id="layerCompetitors" checked onchange="toggleMapLayer('competitors', this.checked)" />
                <span>Competitors</span>
              </label>
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <input type="checkbox" id="layerEmployers" checked onchange="toggleMapLayer('employers', this.checked)" />
                <span>Employers</span>
              </label>
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <input type="checkbox" id="layerHospitals" checked onchange="toggleMapLayer('hospitals', this.checked)" />
                <span>Hospitals</span>
              </label>
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <input type="checkbox" id="layerSchools" checked onchange="toggleMapLayer('schools', this.checked)" />
                <span>Schools</span>
              </label>
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <input type="checkbox" id="layerDemographicsIncome" onchange="toggleMapLayer('demographicsIncome', this.checked)" />
                <span>Income Heatmap</span>
              </label>
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <input type="checkbox" id="layerDemographicsPopulation" onchange="toggleMapLayer('demographicsPopulation', this.checked)" />
                <span>Population Heatmap</span>
              </label>
            </div>
          </div>
          
          <!-- Data Summary Panel -->
          <div id="dataSummaryPanel" style="background: #ffffff; padding: 12px; border-radius: 6px; margin-bottom: 12px; border: 1px solid #e5e7eb; display: none;">
            <div style="font-weight: 600; font-size: 0.9em; margin-bottom: 8px; color: #374151;">Area Statistics</div>
            <div id="dataSummaryContent" style="font-size: 0.85em; color: #666;">
              <div>Click on the map or select an area to view statistics</div>
            </div>
          </div>
          
          <!-- Market Opportunity Panel -->
          <div id="marketOpportunityPanel" style="background: #ffffff; padding: 12px; border-radius: 6px; margin-bottom: 12px; border: 1px solid #e5e7eb; display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <div style="font-weight: 600; font-size: 0.9em; color: #374151;">Market Opportunities</div>
              <button class="btn btn-secondary btn-sm" onclick="loadMarketOpportunities()" style="font-size: 0.8em;">Refresh</button>
            </div>
            <div id="marketOpportunityContent" style="font-size: 0.85em; color: #666; max-height: 200px; overflow-y: auto;">
              <div>Loading opportunities...</div>
            </div>
          </div>
          
          <div id="competitiveMap" style="width:100%; height:600px; border-radius:8px; overflow:hidden; background:#f0f0f0; display:flex; align-items:center; justify-content:center; color:#666;">
            <div>Map will appear here after discovering competitors</div>
          </div>
        </div>
        <div style="flex: 1; padding: 20px; max-height: 640px; overflow-y: auto;">
          <h3 style="margin-top:0; margin-bottom: 15px;">Competitors <span id="competitorCount" style="font-size:0.9em; color:#666; font-weight:normal;"></span></h3>
          <div id="competitiveList"></div>
          <div id="competitivePagination" style="margin-top: 15px; display: none; justify-content: center; align-items: center; gap: 10px; padding: 10px; border-top: 1px solid #e5e7eb;">
            <button class="btn btn-secondary btn-sm" id="prevPage" onclick="changeCompetitorPage(-1)">‚Üê Previous</button>
            <span id="pageInfo" style="color:#666;"></span>
            <button class="btn btn-secondary btn-sm" id="nextPage" onclick="changeCompetitorPage(1)">Next ‚Üí</button>
          </div>
        </div>
      </div>

      <div class="card" id="competitiveInsightsCard" style="display:none;">
        <h3 style="margin-top:0;">Insights</h3>
        <div id="competitiveInsights"></div>
      </div>
    </div>

    <!-- Analyzer Tab -->
    <div id="analyzer" class="tab-content">
      <h2 class="section-title">GMB Profile Analyzer</h2>
      
      <div class="card">
        <p>Analyze your Google My Business profile to get AI-powered recommendations for growth.</p>
        <button class="btn" onclick="analyzeProfile()">üîç Analyze Profile</button>
      </div>

      <div id="analysisResults"></div>
      </div>
    </div>

    <!-- Team Tab -->
    <div id="team" class="tab-content">
      <h2 class="section-title">Team</h2>

      <div class="card">
        <h3 style="margin-top:0;">Invite member</h3>
        <div class="filter-row">
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="inviteEmail" placeholder="teammate@company.com" />
          </div>
          <div class="form-group">
            <label>Role</label>
            <select id="inviteRole">
              <option value="STAFF">Staff</option>
              <option value="ADMIN">Admin</option>
              <option value="OWNER">Owner</option>
            </select>
          </div>
          <div class="form-group">
            <button class="btn" onclick="inviteTeamMember(event)">‚ûï Invite</button>
          </div>
        </div>
        <div id="teamInviteStatus" style="margin-top:10px;"></div>
      </div>

      <div class="card">
        <h3 style="margin-top:0;">Members</h3>
        <div id="teamMembers"></div>
      </div>
    </div>

    <!-- Campaigns Tab -->
    <div id="campaigns" class="tab-content">
      <h2 class="section-title">Geographic Keyword Analysis</h2>
      
      <div class="card">
        <h3>Practice Location Setup</h3>
        <div class="form-group">
          <label>Practice Name</label>
          <input type="text" id="campaignPracticeName" placeholder="Enter practice name">
        </div>
        <div class="form-group">
          <label>Address</label>
          <input type="text" id="campaignPracticeAddress" placeholder="Enter full address">
        </div>
        <div class="form-group">
          <label>Radius (miles)</label>
          <input type="number" id="campaignRadius" value="20" min="5" max="50">
        </div>
        <button class="btn" onclick="saveCampaignPractice()">üíæ Save Practice Location</button>
        <button class="btn btn-secondary" onclick="loadCampaignPractice()">üîÑ Load Existing</button>
      </div>

      <div class="card" id="campaignAreasCard" style="display:none;">
        <h3>Areas Analysis</h3>
        <div id="campaignPracticeInfo" style="margin-bottom:15px; padding:10px; background:#f5f5f5; border-radius:6px;"></div>
        <div class="filter-row">
          <button class="btn" onclick="findCampaignAreas()">üîç Find Areas</button>
          <button class="btn btn-secondary" onclick="fetchCampaignKeywordCosts()">üí∞ Fetch Keyword Costs</button>
          <button class="btn btn-success" onclick="runCampaignAnalysis()">üìä Run Analysis</button>
        </div>
        <div id="campaignAreasStatus" style="margin-top:15px;"></div>
      </div>

      <div class="card" id="campaignResultsCard" style="display:none;">
        <h3>Keyword Costs by Specialty</h3>
        <div class="form-group">
          <label>Filter by Specialty</label>
          <select id="campaignSpecialtyFilter" onchange="filterCampaignKeywords()">
            <option value="">All Procedures</option>
            <option value="veneers">Full Mouth Veneers</option>
            <option value="invisalign">Invisalign</option>
            <option value="all-on-4">All-on-4 Implants</option>
            <option value="implants">Dental Implants</option>
            <option value="cosmetic">Cosmetic Dentistry</option>
          </select>
        </div>
        <div id="campaignKeywordTable" style="overflow-x:auto;">
          <table style="width:100%; border-collapse:collapse;">
      <thead>
              <tr style="background:#f5f5f5;">
                <th style="padding:10px; text-align:left; border-bottom:2px solid #ddd;">Area</th>
                <th style="padding:10px; text-align:left; border-bottom:2px solid #ddd;">Keyword</th>
                <th style="padding:10px; text-align:left; border-bottom:2px solid #ddd;">Specialty</th>
                <th style="padding:10px; text-align:right; border-bottom:2px solid #ddd;">Avg CPC</th>
                <th style="padding:10px; text-align:right; border-bottom:2px solid #ddd;">Min CPC</th>
                <th style="padding:10px; text-align:right; border-bottom:2px solid #ddd;">Max CPC</th>
                <th style="padding:10px; text-align:right; border-bottom:2px solid #ddd;">Volume</th>
                <th style="padding:10px; text-align:left; border-bottom:2px solid #ddd;">Competition</th>
        </tr>
      </thead>
            <tbody id="campaignKeywordTableBody">
            </tbody>
    </table>
        </div>
      </div>

      <div class="card" id="campaignAnalysisCard" style="display:none;">
        <h3>Opportunity Analysis</h3>
        <div id="campaignAnalysisResults"></div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div id="settings" class="tab-content">
      <h2 class="section-title">Settings</h2>

      <div class="card">
        <h3 style="margin-top:0;">Business</h3>
        <div class="filter-row">
          <div class="form-group">
            <label>Business Name</label>
            <input type="text" id="s_businessName" placeholder="e.g., Malama Dental">
          </div>
          <div class="form-group">
            <label>Business Location</label>
            <input type="text" id="s_businessLocation" placeholder="e.g., Long Valley, NJ">
          </div>
        </div>
        <div class="filter-row">
          <div class="form-group">
            <label>Website URL</label>
            <input type="text" id="s_websiteUrl" placeholder="https://malama.dental">
          </div>
          <div class="form-group">
            <label>Business Phone (used for CALL CTA)</label>
            <input type="text" id="s_businessPhone" placeholder="(xxx) xxx-xxxx">
          </div>
        </div>
        <div class="filter-row">
          <div class="form-group">
            <label>Business Email</label>
            <input type="text" id="s_businessEmail" placeholder="office@domain.com">
          </div>
          <div class="form-group">
            <label>Notification Email To</label>
            <input type="text" id="s_emailTo" placeholder="malamadentalgroup@gmail.com">
          </div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top:0;">Scheduler</h3>
        <div class="filter-row">
          <div class="form-group">
            <label style="display:flex; align-items:center; gap:10px;">
              <input type="checkbox" id="s_schedulerEnabled" />
              Enable scheduled jobs
            </label>
          </div>
          <div class="form-group">
            <label>Timezone</label>
            <input type="text" id="s_schedulerTz" placeholder="America/New_York">
          </div>
        </div>
        <div class="filter-row">
          <div class="form-group">
            <label>Daily Reviews Cron (7pm ET default)</label>
            <input type="text" id="s_dailyReviewsCron" placeholder="0 19 * * *">
          </div>
          <div class="form-group">
            <label>Twice Weekly Post Cron</label>
            <input type="text" id="s_twiceWeeklyPostCron" placeholder="0 10 * * 2,5">
          </div>
        </div>
        <div class="filter-row">
          <div class="form-group">
            <label>Monthly Executive Report Cron</label>
            <input type="text" id="s_monthlyReportCron" placeholder="0 9 1 * *">
          </div>
          <div class="form-group">
            <label>Avoid repeating topics from last N posts</label>
            <input type="number" id="s_avoidRepeatLastNPosts" min="0" max="50" value="5">
          </div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top:0;">Review Reply Generation</h3>
        <div class="filter-row">
          <div class="form-group">
            <label>Min Words</label>
            <input type="number" id="s_reviewMinWords" min="0" max="400" value="25">
          </div>
          <div class="form-group">
            <label>Max Words</label>
            <input type="number" id="s_reviewMaxWords" min="10" max="400" value="150">
          </div>
        </div>
        <div class="form-group">
          <label>Signature (supports {businessName})</label>
          <textarea id="s_reviewSignature" rows="3" placeholder="Warm regards,&#10;{businessName} Team"></textarea>
        </div>
        <div class="form-group">
          <label>Signature Variants JSON (optional; supports {businessName}/{businessPhone}/{businessEmail})</label>
          <textarea id="s_reviewSignatureVariantsJson" rows="6" placeholder='{"default":{"en":"Warm regards,\\n{businessName} Team","es":"Saludos cordiales,\\nEquipo de {businessName}"},"negative":{"en":"Sincerely,\\n{businessName} Team"}}'></textarea>
          <small style="color:#777;">Used to vary sign-offs by language and by negative reviews (rating ‚â§ 3 or negative sentiment).</small>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top:0;">Reply Quality Controls (Templates + Voice)</h3>
        <div class="filter-row">
          <div class="form-group">
            <label>Voice Profile</label>
            <select id="voiceSelect" onchange="onVoiceSelected()"></select>
          </div>
          <div class="form-group">
            <label>Template</label>
            <select id="templateSelect" onchange="onTemplateSelected()"></select>
          </div>
        </div>

        <div style="margin-top: 10px; display:flex; gap: 10px; flex-wrap: wrap;">
          <button class="btn btn-secondary btn-sm" onclick="refreshReplyQcConfig()">üîÑ Refresh Templates/Voices</button>
          <button class="btn btn-secondary btn-sm" onclick="newVoiceProfile()">‚ûï New Voice</button>
          <button class="btn btn-secondary btn-sm" onclick="newTemplate()">‚ûï New Template</button>
        </div>

        <div style="margin-top: 16px; border-top: 1px solid #eee; padding-top: 16px;">
          <h4 style="margin: 0 0 10px 0;">Voice Profile Editor</h4>
          <input type="hidden" id="voiceId" />
          <div class="filter-row">
            <div class="form-group">
              <label>Name</label>
              <input type="text" id="voiceName" placeholder="Default" />
            </div>
            <div class="form-group">
              <label style="display:flex; align-items:center; gap:10px;">
                <input type="checkbox" id="voiceEnabled" />
                Enabled
              </label>
            </div>
          </div>
          <div class="filter-row">
            <div class="form-group">
              <label>Tone</label>
              <input type="text" id="voiceTone" placeholder="warm, friendly, professional" />
            </div>
            <div class="form-group">
              <label>Style</label>
              <input type="text" id="voiceStyle" placeholder="concise and professional" />
            </div>
          </div>
          <div class="filter-row">
            <div class="form-group">
              <label>Do List (JSON array)</label>
              <textarea id="voiceDoListJson" rows="3" placeholder='["Thank reviewer","Invite to call if negative"]'></textarea>
            </div>
            <div class="form-group">
              <label>Don't List (JSON array)</label>
              <textarea id="voiceDontListJson" rows="3" placeholder='["Never confirm someone is a patient"]'></textarea>
            </div>
          </div>
          <div class="filter-row">
            <div class="form-group">
              <label>Example Phrases (JSON array)</label>
              <textarea id="voiceExamplePhrasesJson" rows="3" placeholder='["We appreciate your kind words"]'></textarea>
            </div>
            <div class="form-group">
              <label>Banned Phrases (JSON array)</label>
              <textarea id="voiceBannedPhrasesJson" rows="3" placeholder='["as your dentist","your appointment"]'></textarea>
            </div>
          </div>
          <div style="display:flex; gap:10px; flex-wrap: wrap; margin-top: 8px;">
            <button class="btn btn-sm" onclick="saveVoiceProfile(event)">üíæ Save Voice</button>
            <button class="btn btn-danger btn-sm" onclick="deleteVoiceProfile(event)">üóë Delete Voice</button>
          </div>
        </div>

        <div style="margin-top: 16px; border-top: 1px solid #eee; padding-top: 16px;">
          <h4 style="margin: 0 0 10px 0;">Template Editor</h4>
          <input type="hidden" id="templateId" />
          <div class="filter-row">
            <div class="form-group">
              <label>Name</label>
              <input type="text" id="templateName" placeholder="Default template" />
            </div>
            <div class="form-group">
              <label style="display:flex; align-items:center; gap:10px;">
                <input type="checkbox" id="templateEnabled" />
                Enabled
              </label>
            </div>
            <div class="form-group">
              <label>Priority</label>
              <input type="number" id="templatePriority" value="0" />
            </div>
          </div>
          <div class="filter-row">
            <div class="form-group">
              <label>Rating Min</label>
              <input type="number" id="templateRatingMin" value="1" min="1" max="5" />
            </div>
            <div class="form-group">
              <label>Rating Max</label>
              <input type="number" id="templateRatingMax" value="5" min="1" max="5" />
            </div>
            <div class="form-group">
              <label>Sentiment (optional)</label>
              <input type="text" id="templateSentiment" placeholder="positive|neutral|negative" />
            </div>
            <div class="form-group">
              <label>Language Code (optional)</label>
              <input type="text" id="templateLanguageCode" placeholder="en, es, fr, en-US" />
            </div>
          </div>
          <div class="filter-row">
            <div class="form-group">
              <label>Topics JSON (optional; JSON array)</label>
              <textarea id="templateTopicsJson" rows="2" placeholder='["billing","wait time"]'></textarea>
            </div>
            <div class="form-group">
              <label>Variant Hints JSON (optional)</label>
              <textarea id="templateVariantHintsJson" rows="2" placeholder='{"A":"More concise","B":"More empathetic"}'></textarea>
            </div>
          </div>
          <div class="form-group">
            <label>Instructions (optional)</label>
            <textarea id="templateInstructions" rows="3" placeholder="Add any extra rules for this template..."></textarea>
          </div>
          <div class="form-group">
            <label>Body Template (optional; supports {reviewerFirstName}, {businessName}, {topics})</label>
            <textarea id="templateBodyTemplate" rows="4" placeholder="Dear {reviewerFirstName}, ..."></textarea>
          </div>
          <div style="display:flex; gap:10px; flex-wrap: wrap; margin-top: 8px;">
            <button class="btn btn-sm" onclick="saveTemplate(event)">üíæ Save Template</button>
            <button class="btn btn-danger btn-sm" onclick="deleteTemplate(event)">üóë Delete Template</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top:0;">GMB Post Generation</h3>
        <div class="filter-row">
          <div class="form-group">
            <label>Max Words for Posts</label>
            <input type="number" id="s_gmbPostMaxWords" min="10" max="400" value="150">
          </div>
          <div class="form-group">
            <label style="display:flex; align-items:center; gap:10px;">
              <input type="checkbox" id="s_defaultUseSerpApiRankings" />
              Default: include rankings in keyword research (uses SerpAPI)
            </label>
          </div>
        </div>
        <div class="form-group">
          <label style="display:flex; align-items:center; gap:10px;">
            <input type="checkbox" id="s_monthlyReportUseSerpApiRankings" />
            Monthly report: include rankings (uses SerpAPI)
          </label>
        </div>
      </div>

      <button class="btn" onclick="saveSettings(event)">üíæ Save Settings</button>
      <button class="btn btn-secondary" onclick="loadSettings()">‚Ü©Ô∏é Reload</button>
      <div id="settingsStatus" style="margin-top: 12px;"></div>
    </div>

    <script>
    let currentReview = null;
    let currentPost = null;
    let selectedReviewIds = new Set();
    let reviewsById = new Map();
    let voiceProfiles = [];
    let replyTemplates = [];
    let membersForAssign = [];

    // Load stats on page load
    window.addEventListener('DOMContentLoaded', () => {
      // Show stats grid since reviews tab is active by default
      const statsGrid = document.getElementById('statsGrid');
      if (statsGrid) {
        statsGrid.style.display = 'grid';
      }
      loadStats();
      loadReviews();
      checkGoogleConnection();
      handleOAuthCallback();
      loadRankingDefaults();
      loadMe();
      loadSettings(true);
      loadMembersForAssign();
      document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('profileDropdown');
        const btn = document.getElementById('profileBtn');
        if (!dropdown || !btn) return;
        if (dropdown.classList.contains('open')) {
          const t = e.target;
          if (!dropdown.contains(t) && !btn.contains(t)) dropdown.classList.remove('open');
        }
      });
    });

    function escapeHtml(s) {
      return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    async function loadMembersForAssign() {
      // Only owner/admin can call this endpoint; if forbidden, we just hide assignee controls.
      try {
        const res = await fetch('/api/business/members');
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data?.success) {
          membersForAssign = [];
          return;
        }
        membersForAssign = Array.isArray(data.members) ? data.members : [];
      } catch {
        membersForAssign = [];
      }
    }

    function updateBulkToolbar() {
      const toolbar = document.getElementById('bulkToolbar');
      const countEl = document.getElementById('selectedCount');
      const selectAll = document.getElementById('selectAllVisible');
      const count = selectedReviewIds.size;
      if (countEl) countEl.textContent = String(count);
      if (toolbar) toolbar.style.display = reviewsById.size > 0 ? 'flex' : 'none';
      if (selectAll) {
        const ids = Array.from(reviewsById.keys());
        selectAll.checked = ids.length > 0 && ids.every((id) => selectedReviewIds.has(id));
      }
    }

    function toggleReviewSelection(reviewId, checked) {
      const id = Number(reviewId);
      if (!Number.isFinite(id)) return;
      if (checked) selectedReviewIds.add(id);
      else selectedReviewIds.delete(id);
      updateBulkToolbar();
    }

    function toggleSelectAllVisible(checked) {
      const ids = Array.from(reviewsById.keys());
      ids.forEach((id) => {
        if (checked) selectedReviewIds.add(id);
        else selectedReviewIds.delete(id);
        const cb = document.getElementById(`sel-${id}`);
        if (cb) cb.checked = !!checked;
      });
      updateBulkToolbar();
    }

    function clearSelection() {
      Array.from(selectedReviewIds).forEach((id) => {
        const cb = document.getElementById(`sel-${id}`);
        if (cb) cb.checked = false;
      });
      selectedReviewIds = new Set();
      updateBulkToolbar();
    }

    function getSelectedReviewIds() {
      return Array.from(selectedReviewIds);
    }

    function updateOverdueApprovals(reviews) {
      const el = document.getElementById('overdueApprovals');
      if (!el) return;
      const now = Date.now();
      const overdue = (reviews || []).filter((r) => {
        if (r.status !== 'Needs Approval') return false;
        if (r.repliedAt) return false;
        const since = r.needsApprovalSince || r.lastAnalyzedAt || r.createTime;
        const t = since ? new Date(since).getTime() : 0;
        return t > 0 && (now - t) >= (24 * 60 * 60 * 1000);
      });
      if (overdue.length === 0) {
        el.textContent = '';
        return;
      }
      const oldestMs = Math.max(...overdue.map((r) => {
        const since = r.needsApprovalSince || r.lastAnalyzedAt || r.createTime;
        return now - new Date(since).getTime();
      }));
      const oldestHours = Math.floor(oldestMs / (1000 * 60 * 60));
      el.textContent = `Overdue approvals: ${overdue.length} (oldest ~${oldestHours}h)`;
    }

    async function bulkApproveAndPost() {
      const ids = getSelectedReviewIds();
      if (ids.length === 0) {
        showWarning('Select at least one review first.', 'Bulk Approve & Post');
        return;
      }
      if (!confirm(`Approve and post replies for ${ids.length} selected review(s)?`)) return;
      try {
        const res = await fetch('/api/reviews/bulk/approve-and-post', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reviewIds: ids }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.error || data?.message || 'Bulk approve+post failed');
        const c = data?.counts || {};
        showSuccess(`Posted: ${c.posted || 0}, skipped: ${c.skipped || 0}, failed: ${c.failed || 0}`, 'Bulk Approve & Post');
        clearSelection();
        await loadReviews();
        await loadStats();
      } catch (e) {
        showError(e.message || 'Bulk approve+post failed', 'Bulk Approve & Post');
      }
    }

    async function bulkCopyDrafts() {
      const ids = getSelectedReviewIds();
      if (ids.length === 0) {
        showWarning('Select at least one review first.', 'Copy Drafts');
        return;
      }
      const blocks = [];
      for (const id of ids) {
        const r = reviewsById.get(id);
        if (!r) continue;
        const header = `${r.authorName} | ${r.rating}‚òÖ | ${new Date(r.createTime).toLocaleDateString()}`;
        const draft = r.replyDraft ? String(r.replyDraft) : '(no draft)';
        blocks.push(`${header}\n${draft}`);
      }
      const text = blocks.join('\n\n' + '-'.repeat(60) + '\n\n');
      try {
        await navigator.clipboard.writeText(text);
        showSuccess(`Copied ${blocks.length} draft(s) to clipboard.`, 'Copy Drafts');
      } catch {
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        ta.remove();
        showSuccess(`Copied ${blocks.length} draft(s) to clipboard.`, 'Copy Drafts');
      }
    }

    function renderAssigneeHtml(review) {
      if (!Array.isArray(membersForAssign) || membersForAssign.length === 0) return '';
      const assigned = review.assignedToUserId || '';
      const opts = [
        `<option value="">Unassigned</option>`,
        ...membersForAssign.map((m) => {
          const label = escapeHtml(m.name || m.email || m.userId || 'Member');
          const selected = String(m.userId) === String(assigned) ? 'selected' : '';
          return `<option value="${escapeHtml(m.userId)}" ${selected}>${label}</option>`;
        }),
      ].join('');
      return `
        <div style="margin-top: 10px; display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
          <span class="badge badge-info">Assignee</span>
          <select onchange="assignReview(${review.id}, this.value)" style="padding: 6px 10px; border-radius: 8px; border: 1px solid #e0e0e0;">
            ${opts}
          </select>
        </div>
      `;
    }

    async function assignReview(reviewId, userId) {
      try {
        const assignedToUserId = userId ? String(userId) : null;
        const res = await fetch(`/api/reviews/${reviewId}/assign`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ assignedToUserId }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.error || data?.message || 'Failed to assign');
        showSuccess('Assignment updated', 'Assignee');
      } catch (e) {
        showError(e.message || 'Failed to assign', 'Assignee');
      }
    }

    function diffLines(oldText, newText) {
      const a = String(oldText || '').split('\n');
      const b = String(newText || '').split('\n');
      const n = a.length;
      const m = b.length;
      const dp = Array.from({ length: n + 1 }, () => Array(m + 1).fill(0));
      for (let i = n - 1; i >= 0; i--) {
        for (let j = m - 1; j >= 0; j--) {
          dp[i][j] = a[i] === b[j] ? dp[i + 1][j + 1] + 1 : Math.max(dp[i + 1][j], dp[i][j + 1]);
        }
      }
      const out = [];
      let i = 0, j = 0;
      while (i < n && j < m) {
        if (a[i] === b[j]) {
          out.push({ t: 'same', v: a[i] });
          i++; j++;
        } else if (dp[i + 1][j] >= dp[i][j + 1]) {
          out.push({ t: 'del', v: a[i] });
          i++;
        } else {
          out.push({ t: 'add', v: b[j] });
          j++;
        }
      }
      while (i < n) out.push({ t: 'del', v: a[i++] });
      while (j < m) out.push({ t: 'add', v: b[j++] });
      return out;
    }

    function openGenericModal(title, bodyHtml) {
      closeGenericModal();
      const backdrop = document.createElement('div');
      backdrop.id = 'genericModalBackdrop';
      backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 9999; animation: fadeIn 0.2s ease-out;';
      const modal = document.createElement('div');
      modal.id = 'genericModalContainer';
      modal.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 22px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 10000; max-width: 900px; width: 92%; max-height: 85vh; overflow-y: auto; animation: modalSlideIn 0.3s ease-out;';
      modal.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
          <h3 style="margin:0;">${escapeHtml(title)}</h3>
          <button class="btn btn-secondary btn-sm" type="button" onclick="closeGenericModal()">Close</button>
        </div>
        <div style="margin-top: 14px;">${bodyHtml}</div>
      `;
      backdrop.addEventListener('click', (e) => { if (e.target === backdrop) closeGenericModal(); });
      document.body.appendChild(backdrop);
      document.body.appendChild(modal);
    }

    function closeGenericModal() {
      const backdrop = document.getElementById('genericModalBackdrop');
      const modal = document.getElementById('genericModalContainer');
      if (backdrop) {
        backdrop.style.animation = 'fadeOut 0.2s ease-out forwards';
        setTimeout(() => backdrop.remove(), 200);
      }
      if (modal) {
        modal.style.animation = 'modalSlideOut 0.2s ease-out forwards';
        setTimeout(() => modal.remove(), 200);
      }
    }

    async function openHistory(reviewId) {
      try {
        const res = await fetch(`/api/reviews/${reviewId}/versions`);
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data?.success) throw new Error(data?.error || 'Failed to load history');
        const versions = Array.isArray(data.versions) ? data.versions : [];
        const rows = versions.map((v) => {
          const who = v.createdBy?.name || v.createdBy?.email || (v.createdByUserId ? String(v.createdByUserId).slice(0, 8) : '‚Äî');
          const when = v.createdAt ? new Date(v.createdAt).toLocaleString() : '';
          const label = `${v.source || 'unknown'} ‚Ä¢ ${who} ‚Ä¢ ${when}`;
          return `
            <div class="card" style="margin-bottom: 12px;">
              <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;">
                <div>
                  <div style="font-weight:800;">${escapeHtml(label)}</div>
                  <div class="small-muted">${escapeHtml(v.note || '')}</div>
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  <button class="btn btn-secondary btn-sm" onclick="viewDiff(${reviewId}, '${v.id}')">Diff</button>
                  <button class="btn btn-success btn-sm" onclick="restoreVersion(${reviewId}, '${v.id}')">Restore</button>
                </div>
              </div>
              <div class="reply-draft" style="margin-top:10px; white-space: pre-wrap;">${escapeHtml((v.text || '').slice(0, 500))}${(v.text || '').length > 500 ? '‚Ä¶' : ''}</div>
            </div>
          `;
        }).join('');
        openGenericModal(`Reply history (Review #${reviewId})`, rows || '<div class="empty-state"><p>No versions yet</p></div>');
      } catch (e) {
        showError(e.message || 'Failed to load history', 'History');
      }
    }

    async function viewDiff(reviewId, versionId) {
      try {
        const res = await fetch(`/api/reviews/${reviewId}/versions`);
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data?.success) throw new Error(data?.error || 'Failed to load versions');
        const versions = Array.isArray(data.versions) ? data.versions : [];
        const v = versions.find((x) => x.id === versionId);
        if (!v) throw new Error('Version not found');
        const current = reviewsById.get(Number(reviewId)) || (await fetch(`/api/reviews/${reviewId}`).then(r => r.json()));
        const ops = diffLines(v.text || '', current?.replyDraft || '');
        const html = ops.map((op) => {
          const cls = op.t === 'add' ? 'diff-add' : op.t === 'del' ? 'diff-del' : 'diff-same';
          const prefix = op.t === 'add' ? '+ ' : op.t === 'del' ? '- ' : '  ';
          return `<span class="diff-line ${cls}">${escapeHtml(prefix + op.v)}</span>`;
        }).join('');
        openGenericModal('Diff (version ‚Üí current)', `<pre class="diff-pre mono">${html}</pre>`);
      } catch (e) {
        showError(e.message || 'Failed to render diff', 'Diff');
      }
    }

    async function restoreVersion(reviewId, versionId) {
      if (!confirm('Restore this version as the current draft?')) return;
      try {
        const res = await fetch(`/api/reviews/${reviewId}/versions/${versionId}/restore`, { method: 'POST' });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data?.success) throw new Error(data?.error || data?.message || 'Failed to restore');
        showSuccess('Draft restored', 'History');
        closeGenericModal();
        await loadReviews();
      } catch (e) {
        showError(e.message || 'Failed to restore', 'History');
      }
    }

    function toggleProfileMenu() {
      const dropdown = document.getElementById('profileDropdown');
      if (!dropdown) return;
      dropdown.classList.toggle('open');
    }

    function openSettings() {
      const dropdown = document.getElementById('profileDropdown');
      if (dropdown) dropdown.classList.remove('open');
      showTab('settings', null);
      loadSettings();
    }

    async function doLogout() {
      try {
        await fetch('/api/auth/logout', { method: 'POST' });
      } catch (e) {
        // ignore
      } finally {
        window.location.href = '/login';
      }
    }

    async function loadMe() {
      try {
        const res = await fetch('/api/me');
        const data = await res.json();
        if (!res.ok) return;

        const user = data.user || {};
        const memberships = Array.isArray(data.memberships) ? data.memberships : [];
        const activeBusinessId = data.activeBusinessId;

        const active = memberships.find((m) => m.businessId === activeBusinessId) || memberships[0];
        const activeName = active?.business?.name || 'Business';
        const activeRole = String(active?.role || 'STAFF').toUpperCase();

        const name = user.name || user.email || 'User';
        const email = user.email || '';
        const initials = String(name).trim().split(/\s+/).slice(0, 2).map(s => s[0]?.toUpperCase()).join('') || 'U';

        const avatarEl = document.getElementById('profileAvatar');
        const nameEl = document.getElementById('profileName');
        const emailEl = document.getElementById('profileEmail');
        const pdNameEl = document.getElementById('pdName');
        const pdEmailEl = document.getElementById('pdEmail');
        if (avatarEl) avatarEl.textContent = initials;
        if (nameEl) nameEl.textContent = name;
        if (emailEl) emailEl.textContent = email;
        if (pdNameEl) pdNameEl.textContent = name;
        if (pdEmailEl) pdEmailEl.textContent = email;

        // Header business name (prefer active business name)
        const headerName = document.getElementById('headerBusinessName');
        if (headerName) headerName.textContent = activeName;

        // Business switcher
        const wrap = document.getElementById('bizSwitcherWrap');
        const sel = document.getElementById('bizSwitcher');
        if (wrap && sel && memberships.length > 1) {
          wrap.style.display = 'inline-flex';
          sel.innerHTML = memberships.map((m) => {
            const bid = m.businessId;
            const label = m.business?.name || bid;
            const selected = bid === activeBusinessId ? 'selected' : '';
            return `<option value="${bid}" ${selected}>${label}</option>`;
          }).join('');
        } else if (wrap) {
          wrap.style.display = 'none';
        }

        // Team button visibility in profile dropdown for Owner/Admin
        const teamProfileBtn = document.getElementById('teamProfileBtn');
        if (teamProfileBtn) {
          teamProfileBtn.style.display = (activeRole === 'OWNER' || activeRole === 'ADMIN') ? 'block' : 'none';
        }
      } catch (e) {
        // non-fatal
      }
    }

    async function switchBusiness(event) {
      try {
        const businessId = event?.target?.value;
        if (!businessId) return;
        const res = await fetch('/api/business/switch', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ businessId }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.error || 'Failed to switch business');
        // simplest: reload to re-fetch everything scoped to new tenant
        window.location.reload();
      } catch (e) {
        showError(e.message || 'Failed to switch business', 'Business');
      }
    }

    async function inviteTeamMember(event) {
      const btn = event?.target;
      if (btn) btn.disabled = true;
      const statusEl = document.getElementById('teamInviteStatus');
      try {
        const email = document.getElementById('inviteEmail')?.value?.trim();
        const role = document.getElementById('inviteRole')?.value || 'STAFF';
        if (!email) throw new Error('Email is required');
        if (statusEl) statusEl.textContent = 'Sending invite...';
        const res = await fetch('/api/business/invite', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, role }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.error || 'Failed to invite');
        if (statusEl) statusEl.textContent = 'Invite sent.';
        await loadTeam();
      } catch (e) {
        if (statusEl) statusEl.textContent = e.message || 'Invite failed';
      } finally {
        if (btn) btn.disabled = false;
      }
    }

    // Campaigns / Geographic Keyword Analysis
    let currentPracticeId = null;
    let allKeywordCosts = [];

    async function loadCampaignPractice() {
      try {
        const res = await fetch('/api/geographic/practices');
        const data = await res.json().catch(() => []);
        if (Array.isArray(data) && data.length > 0) {
          const practice = data[0];
          currentPracticeId = practice.id;
          document.getElementById('campaignPracticeName').value = practice.name || '';
          document.getElementById('campaignPracticeAddress').value = practice.address || '';
          document.getElementById('campaignRadius').value = practice.radiusMiles || 20;
          document.getElementById('campaignAreasCard').style.display = 'block';
          document.getElementById('campaignPracticeInfo').innerHTML = `
            <strong>${practice.name}</strong><br>
            ${practice.address}<br>
            <small>Radius: ${practice.radiusMiles} miles | Areas: ${practice._count?.areas || 0}</small>
          `;
        }
      } catch (e) {
        console.error('Failed to load practice:', e);
      }
    }

    async function saveCampaignPractice() {
      const name = document.getElementById('campaignPracticeName').value.trim();
      const address = document.getElementById('campaignPracticeAddress').value.trim();
      const radius = parseInt(document.getElementById('campaignRadius').value) || 20;

      if (!name || !address) {
        showError('Practice name and address are required');
        return;
      }

      try {
        const res = await fetch('/api/geographic/practice', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, address, radiusMiles: radius }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.error || 'Failed to save practice');
        currentPracticeId = data.practice?.id || null;
        showSuccess('Practice location saved');
        await loadCampaignPractice();
      } catch (e) {
        showError(e.message || 'Failed to save practice');
      }
    }

    async function findCampaignAreas() {
      if (!currentPracticeId) {
        showError('Please save a practice location first');
        return;
      }
      const statusEl = document.getElementById('campaignAreasStatus');
      if (statusEl) statusEl.innerHTML = '<div style="color:#666;">Finding areas...</div>';
      try {
        const res = await fetch('/api/geographic/areas/find', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ practiceId: currentPracticeId, forceRefresh: false }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.error || 'Failed to find areas');
        if (statusEl) statusEl.innerHTML = `<div style="color:green;">‚úì Found ${data.count || 0} areas within radius</div>`;
        showSuccess(`Found ${data.count || 0} areas`);
      } catch (e) {
        if (statusEl) statusEl.innerHTML = `<div style="color:red;">Error: ${e.message}</div>`;
        showError(e.message || 'Failed to find areas');
      }
    }

    async function fetchCampaignKeywordCosts() {
      if (!currentPracticeId) {
        showError('Please save a practice location first');
        return;
      }
      showInfo('Fetching keyword costs... This may take a few minutes.');
      try {
        const res = await fetch('/api/keywords/costs/fetch', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ practiceId: currentPracticeId, forceRefresh: false }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.error || 'Failed to fetch keyword costs');
        showSuccess('Keyword cost fetching started. Check back in a few minutes.');
        setTimeout(() => loadCampaignKeywordCosts(), 5000);
      } catch (e) {
        showError(e.message || 'Failed to fetch keyword costs');
      }
    }

    async function loadCampaignKeywordCosts() {
      if (!currentPracticeId) return;
      try {
        const res = await fetch(`/api/keywords/costs?practiceId=${currentPracticeId}`);
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.error || 'Failed to load keyword costs');
        allKeywordCosts = Array.isArray(data.costs) ? data.costs : [];
        document.getElementById('campaignResultsCard').style.display = 'block';
        filterCampaignKeywords();
      } catch (e) {
        console.error('Failed to load keyword costs:', e);
      }
    }

    function filterCampaignKeywords() {
      const specialty = document.getElementById('campaignSpecialtyFilter').value;
      const filtered = specialty 
        ? allKeywordCosts.filter(c => c.specialtyType === specialty)
        : allKeywordCosts;
      
      const tbody = document.getElementById('campaignKeywordTableBody');
      if (!tbody) return;
      
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px; color:#666;">No keyword cost data available</td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map(cost => {
        const competitionColor = {
          'LOW': 'green',
          'MEDIUM': 'orange',
          'HIGH': 'red'
        }[cost.competition] || 'gray';
        return `
          <tr>
            <td style="padding:8px; border-bottom:1px solid #eee;">${cost.area?.name || 'Unknown'}</td>
            <td style="padding:8px; border-bottom:1px solid #eee;">${cost.keyword}</td>
            <td style="padding:8px; border-bottom:1px solid #eee;">${cost.specialtyType || '-'}</td>
            <td style="padding:8px; border-bottom:1px solid #eee; text-align:right;">$${cost.avgCpc.toFixed(2)}</td>
            <td style="padding:8px; border-bottom:1px solid #eee; text-align:right;">$${cost.minCpc.toFixed(2)}</td>
            <td style="padding:8px; border-bottom:1px solid #eee; text-align:right;">$${cost.maxCpc.toFixed(2)}</td>
            <td style="padding:8px; border-bottom:1px solid #eee; text-align:right;">${cost.searchVolume.toLocaleString()}</td>
            <td style="padding:8px; border-bottom:1px solid #eee;">
              <span style="color:${competitionColor}; font-weight:600;">${cost.competition}</span>
            </td>
          </tr>
        `;
      }).join('');
    }

    async function runCampaignAnalysis() {
      if (!currentPracticeId) {
        showError('Please save a practice location first');
        return;
      }
      showInfo('Running analysis... This may take a few minutes.');
      try {
        const res = await fetch('/api/geographic/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ practiceId: currentPracticeId, forceRefresh: false }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.error || 'Failed to run analysis');
        document.getElementById('campaignAnalysisCard').style.display = 'block';
        const resultsEl = document.getElementById('campaignAnalysisResults');
        if (resultsEl && data.analysis) {
          const topAreas = data.analysis.rankedAreas || [];
          resultsEl.innerHTML = `
            <div style="margin-bottom:15px; padding:15px; background:#f0f7ff; border-radius:6px;">
              <strong>Summary:</strong> ${data.analysis.summary || ''}
            </div>
            <h4>Top Opportunity Areas:</h4>
            <table style="width:100%; border-collapse:collapse; margin-top:10px;">
              <thead>
                <tr style="background:#f5f5f5;">
                  <th style="padding:10px; text-align:left;">Area</th>
                  <th style="padding:10px; text-align:right;">Score</th>
                  <th style="padding:10px; text-align:right;">Avg CPC</th>
                  <th style="padding:10px; text-align:right;">Volume</th>
                  <th style="padding:10px; text-align:right;">Distance</th>
                </tr>
              </thead>
              <tbody>
                ${topAreas.slice(0, 10).map(area => `
                  <tr>
                    <td style="padding:8px; border-bottom:1px solid #eee;">${area.areaName}</td>
                    <td style="padding:8px; border-bottom:1px solid #eee; text-align:right;">${area.score.toFixed(2)}</td>
                    <td style="padding:8px; border-bottom:1px solid #eee; text-align:right;">$${area.avgCpc.toFixed(2)}</td>
                    <td style="padding:8px; border-bottom:1px solid #eee; text-align:right;">${area.totalVolume.toLocaleString()}</td>
                    <td style="padding:8px; border-bottom:1px solid #eee; text-align:right;">${area.distanceMiles.toFixed(1)} mi</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }
        showSuccess('Analysis complete');
      } catch (e) {
        showError(e.message || 'Failed to run analysis');
      }
    }

    async function loadTeam() {
      const container = document.getElementById('teamMembers');
      if (container) container.innerHTML = '<div style="color:#666;">Loading...</div>';
      try {
        const res = await fetch('/api/business/members');
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.error || 'Failed to load members');
        const members = Array.isArray(data.members) ? data.members : [];
        const rows = members.map((m) => {
          const safeEmail = (m.email || '').replace(/</g, '&lt;');
          const safeName = (m.name || '').replace(/</g, '&lt;');
          return `
            <div style="display:flex; gap:10px; align-items:center; padding:10px 0; border-bottom:1px solid #eee;">
              <div style="flex:1; min-width:0;">
                <div style="font-weight:800;">${safeName || safeEmail}</div>
                <div style="color:#666; font-size:0.9rem; word-break:break-all;">${safeEmail}</div>
              </div>
              <div>
                <select onchange="updateMemberRole('${m.userId}', this.value)">
                  <option value="STAFF" ${String(m.role).toUpperCase()==='STAFF'?'selected':''}>Staff</option>
                  <option value="ADMIN" ${String(m.role).toUpperCase()==='ADMIN'?'selected':''}>Admin</option>
                  <option value="OWNER" ${String(m.role).toUpperCase()==='OWNER'?'selected':''}>Owner</option>
                </select>
              </div>
              <div>
                <button class="btn btn-secondary btn-sm" onclick="removeMember('${m.userId}')">Remove</button>
              </div>
            </div>
          `;
        }).join('');
        if (container) container.innerHTML = rows || '<div style="color:#666;">No members</div>';
      } catch (e) {
        if (container) container.innerHTML = `<div style="color:#b42318;">${e.message || 'Failed to load members'}</div>`;
      }
    }

    async function updateMemberRole(userId, role) {
      try {
        const res = await fetch(`/api/business/members/${encodeURIComponent(userId)}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ role }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.error || 'Failed to update role');
        showSuccess('Role updated', 'Team');
      } catch (e) {
        showError(e.message || 'Failed to update role', 'Team');
      }
    }

    async function removeMember(userId) {
      if (!confirm('Remove this member from the business?')) return;
      try {
        const res = await fetch(`/api/business/members/${encodeURIComponent(userId)}`, { method: 'DELETE' });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data?.error || 'Failed to remove member');
        await loadTeam();
        showSuccess('Member removed', 'Team');
      } catch (e) {
        showError(e.message || 'Failed to remove member', 'Team');
      }
    }

    async function loadSettings(silent = false) {
      try {
        const res = await fetch('/api/settings');
        const data = await res.json();
        if (!res.ok || !data?.success) throw new Error(data?.error || 'Failed to load settings');
        const s = data.settings;

        // Header name
        const headerName = document.getElementById('headerBusinessName');
        if (headerName) headerName.textContent = s.businessName || 'Malama Dental';

        // Form fields
        const setVal = (id, v) => { const el = document.getElementById(id); if (el) el.value = v ?? ''; };
        const setNum = (id, v) => { const el = document.getElementById(id); if (el) el.value = String(v ?? ''); };
        const setChk = (id, v) => { const el = document.getElementById(id); if (el) el.checked = !!v; };

        setVal('s_businessName', s.businessName);
        setVal('s_businessLocation', s.businessLocation);
        setVal('s_websiteUrl', s.websiteUrl);
        setVal('s_businessPhone', s.businessPhone || '');
        setVal('s_businessEmail', s.businessEmail || '');
        setVal('s_emailTo', s.emailTo);

        setChk('s_schedulerEnabled', s.schedulerEnabled);
        setVal('s_schedulerTz', s.schedulerTz);
        setVal('s_dailyReviewsCron', s.dailyReviewsCron);
        setVal('s_twiceWeeklyPostCron', s.twiceWeeklyPostCron);
        setVal('s_monthlyReportCron', s.monthlyReportCron);
        setNum('s_avoidRepeatLastNPosts', s.avoidRepeatLastNPosts);

        setNum('s_reviewMinWords', s.reviewMinWords);
        setNum('s_reviewMaxWords', s.reviewMaxWords);
        setVal('s_reviewSignature', s.reviewSignature);
        setVal('s_reviewSignatureVariantsJson', s.reviewSignatureVariantsJson || '');

        setNum('s_gmbPostMaxWords', s.gmbPostMaxWords);
        setChk('s_defaultUseSerpApiRankings', s.defaultUseSerpApiRankings);
        setChk('s_monthlyReportUseSerpApiRankings', s.monthlyReportUseSerpApiRankings);

        // Keyword research checkbox default
        const researchChk = document.getElementById('useSerpApiRankings');
        if (researchChk && researchChk.checked === false && researchChk.defaultChecked === false) {
          researchChk.checked = !!s.defaultUseSerpApiRankings;
        }

        // Keep reply quality controls UI in sync
        try { await refreshReplyQcConfig(true); } catch (_) {}

        if (!silent) showSuccess('Settings loaded', 'Settings');
      } catch (e) {
        if (!silent) showError(e.message || 'Failed to load settings', 'Settings');
      }
    }

    async function saveSettings(event) {
      const btn = event?.target;
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span> Saving...';
      }

      try {
        const patch = {
          businessName: document.getElementById('s_businessName')?.value?.trim(),
          businessLocation: document.getElementById('s_businessLocation')?.value?.trim(),
          websiteUrl: document.getElementById('s_websiteUrl')?.value?.trim(),
          businessPhone: document.getElementById('s_businessPhone')?.value?.trim() || null,
          businessEmail: document.getElementById('s_businessEmail')?.value?.trim() || null,
          emailTo: document.getElementById('s_emailTo')?.value?.trim(),

          schedulerEnabled: !!document.getElementById('s_schedulerEnabled')?.checked,
          schedulerTz: document.getElementById('s_schedulerTz')?.value?.trim(),
          dailyReviewsCron: document.getElementById('s_dailyReviewsCron')?.value?.trim(),
          twiceWeeklyPostCron: document.getElementById('s_twiceWeeklyPostCron')?.value?.trim(),
          monthlyReportCron: document.getElementById('s_monthlyReportCron')?.value?.trim(),
          avoidRepeatLastNPosts: parseInt(document.getElementById('s_avoidRepeatLastNPosts')?.value || '5'),

          reviewMinWords: parseInt(document.getElementById('s_reviewMinWords')?.value || '25'),
          reviewMaxWords: parseInt(document.getElementById('s_reviewMaxWords')?.value || '150'),
          reviewSignature: document.getElementById('s_reviewSignature')?.value || 'Warm regards,\n{businessName} Team',
          reviewSignatureVariantsJson: (() => {
            const v = document.getElementById('s_reviewSignatureVariantsJson')?.value;
            const s = (v ?? '').trim();
            return s.length === 0 ? null : v;
          })(),

          gmbPostMaxWords: parseInt(document.getElementById('s_gmbPostMaxWords')?.value || '150'),
          defaultUseSerpApiRankings: !!document.getElementById('s_defaultUseSerpApiRankings')?.checked,
          monthlyReportUseSerpApiRankings: !!document.getElementById('s_monthlyReportUseSerpApiRankings')?.checked,
        };

        // remove empty strings so we don‚Äôt overwrite with blanks accidentally
        Object.keys(patch).forEach(k => {
          if (patch[k] === '') delete patch[k];
          if (typeof patch[k] === 'undefined') delete patch[k];
        });

        const res = await fetch('/api/settings', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(patch),
        });
        const data = await res.json();
        if (!res.ok || !data?.success) throw new Error(data?.error || 'Failed to save settings');

        // Update header + defaults immediately
        await loadSettings(true);
        showSuccess('Settings saved. Scheduler updated automatically.', 'Saved');
      } catch (e) {
        showError(e.message || 'Failed to save settings', 'Settings');
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = 'üíæ Save Settings';
        }
      }
    }

    async function refreshReplyQcConfig(silent = false) {
      try {
        const [voicesRes, templatesRes] = await Promise.all([
          fetch('/api/reply-voices'),
          fetch('/api/reply-templates'),
        ]);
        const voicesData = await voicesRes.json().catch(() => ({}));
        const templatesData = await templatesRes.json().catch(() => ({}));
        if (!voicesRes.ok) throw new Error(voicesData?.error || 'Failed to load voice profiles');
        if (!templatesRes.ok) throw new Error(templatesData?.error || 'Failed to load templates');

        voiceProfiles = Array.isArray(voicesData.voices) ? voicesData.voices : [];
        replyTemplates = Array.isArray(templatesData.templates) ? templatesData.templates : [];

        const voiceSel = document.getElementById('voiceSelect');
        if (voiceSel) {
          voiceSel.innerHTML = `<option value="">(none)</option>` + voiceProfiles
            .map(v => `<option value="${escapeHtml(v.id)}">${escapeHtml(v.name || 'Unnamed')}${v.enabled ? '' : ' (disabled)'}</option>`)
            .join('');
        }
        const tplSel = document.getElementById('templateSelect');
        if (tplSel) {
          tplSel.innerHTML = `<option value="">(none)</option>` + replyTemplates
            .map(t => `<option value="${escapeHtml(t.id)}">${escapeHtml(t.name || 'Unnamed')} (p${Number(t.priority || 0)})${t.enabled ? '' : ' (disabled)'}</option>`)
            .join('');
        }

        // Auto-select most recent items if nothing selected
        if (voiceProfiles.length > 0 && voiceSel && !voiceSel.value) {
          voiceSel.value = String(voiceProfiles[0].id);
        }
        if (replyTemplates.length > 0 && tplSel && !tplSel.value) {
          tplSel.value = String(replyTemplates[0].id);
        }
        onVoiceSelected();
        onTemplateSelected();

        if (!silent) showSuccess('Templates/voices loaded', 'Reply QC');
      } catch (e) {
        if (!silent) showError(e.message || 'Failed to load templates/voices', 'Reply QC');
      }
    }

    function onVoiceSelected() {
      const sel = document.getElementById('voiceSelect');
      const id = sel ? String(sel.value || '') : '';
      const v = voiceProfiles.find(x => String(x.id) === id) || null;

      const setVal = (id, v) => { const el = document.getElementById(id); if (el) el.value = v ?? ''; };
      const setChk = (id, v) => { const el = document.getElementById(id); if (el) el.checked = !!v; };

      setVal('voiceId', v?.id || '');
      setVal('voiceName', v?.name || '');
      setChk('voiceEnabled', v?.enabled !== false);
      setVal('voiceTone', v?.tone || '');
      setVal('voiceStyle', v?.style || '');
      setVal('voiceDoListJson', v?.doListJson || '');
      setVal('voiceDontListJson', v?.dontListJson || '');
      setVal('voiceExamplePhrasesJson', v?.examplePhrasesJson || '');
      setVal('voiceBannedPhrasesJson', v?.bannedPhrasesJson || '');
    }

    function onTemplateSelected() {
      const sel = document.getElementById('templateSelect');
      const id = sel ? String(sel.value || '') : '';
      const t = replyTemplates.find(x => String(x.id) === id) || null;

      const setVal = (id, v) => { const el = document.getElementById(id); if (el) el.value = v ?? ''; };
      const setNum = (id, v) => { const el = document.getElementById(id); if (el) el.value = String(v ?? ''); };
      const setChk = (id, v) => { const el = document.getElementById(id); if (el) el.checked = !!v; };

      setVal('templateId', t?.id || '');
      setVal('templateName', t?.name || '');
      setChk('templateEnabled', t?.enabled !== false);
      setNum('templatePriority', t?.priority ?? 0);
      setNum('templateRatingMin', t?.ratingMin ?? 1);
      setNum('templateRatingMax', t?.ratingMax ?? 5);
      setVal('templateSentiment', t?.sentiment ?? '');
      setVal('templateLanguageCode', t?.languageCode ?? '');
      setVal('templateTopicsJson', t?.topicsJson ?? '');
      setVal('templateVariantHintsJson', t?.variantHintsJson ?? '');
      setVal('templateInstructions', t?.instructions ?? '');
      setVal('templateBodyTemplate', t?.bodyTemplate ?? '');
    }

    function newVoiceProfile() {
      const setVal = (id, v) => { const el = document.getElementById(id); if (el) el.value = v ?? ''; };
      const setChk = (id, v) => { const el = document.getElementById(id); if (el) el.checked = !!v; };
      setVal('voiceId', '');
      setVal('voiceName', 'Default');
      setChk('voiceEnabled', true);
      setVal('voiceTone', 'warm, friendly, professional');
      setVal('voiceStyle', 'concise and professional');
      setVal('voiceDoListJson', '[]');
      setVal('voiceDontListJson', '[]');
      setVal('voiceExamplePhrasesJson', '[]');
      setVal('voiceBannedPhrasesJson', '[]');
    }

    async function saveVoiceProfile(event) {
      const btn = event?.target;
      if (btn) { btn.disabled = true; btn.innerHTML = '<span class="loading"></span> Saving...'; }
      try {
        const id = document.getElementById('voiceId')?.value || '';
        const body = {
          name: document.getElementById('voiceName')?.value?.trim() || 'Default',
          enabled: !!document.getElementById('voiceEnabled')?.checked,
          tone: document.getElementById('voiceTone')?.value || '',
          style: document.getElementById('voiceStyle')?.value || '',
          doListJson: document.getElementById('voiceDoListJson')?.value || null,
          dontListJson: document.getElementById('voiceDontListJson')?.value || null,
          examplePhrasesJson: document.getElementById('voiceExamplePhrasesJson')?.value || null,
          bannedPhrasesJson: document.getElementById('voiceBannedPhrasesJson')?.value || null,
        };
        const url = id ? `/api/reply-voices/${encodeURIComponent(id)}` : '/api/reply-voices';
        const method = id ? 'PUT' : 'POST';
        const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data?.success) throw new Error(data?.error || 'Failed to save voice');
        await refreshReplyQcConfig(true);
        showSuccess('Voice saved', 'Reply QC');
      } catch (e) {
        showError(e.message || 'Failed to save voice', 'Reply QC');
      } finally {
        if (btn) { btn.disabled = false; btn.innerHTML = 'üíæ Save Voice'; }
      }
    }

    async function deleteVoiceProfile(event) {
      const id = document.getElementById('voiceId')?.value || '';
      if (!id) { showWarning('Select a voice profile first', 'Reply QC'); return; }
      if (!confirm('Delete this voice profile?')) return;
      const btn = event?.target;
      if (btn) { btn.disabled = true; btn.innerHTML = '<span class="loading"></span> Deleting...'; }
      try {
        const res = await fetch(`/api/reply-voices/${encodeURIComponent(id)}`, { method: 'DELETE' });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data?.success) throw new Error(data?.error || 'Failed to delete voice');
        await refreshReplyQcConfig(true);
        newVoiceProfile();
        showSuccess('Voice deleted', 'Reply QC');
      } catch (e) {
        showError(e.message || 'Failed to delete voice', 'Reply QC');
      } finally {
        if (btn) { btn.disabled = false; btn.innerHTML = 'üóë Delete Voice'; }
      }
    }

    function newTemplate() {
      const setVal = (id, v) => { const el = document.getElementById(id); if (el) el.value = v ?? ''; };
      const setNum = (id, v) => { const el = document.getElementById(id); if (el) el.value = String(v ?? ''); };
      const setChk = (id, v) => { const el = document.getElementById(id); if (el) el.checked = !!v; };
      setVal('templateId', '');
      setVal('templateName', 'Default template');
      setChk('templateEnabled', true);
      setNum('templatePriority', 0);
      setNum('templateRatingMin', 1);
      setNum('templateRatingMax', 5);
      setVal('templateSentiment', '');
      setVal('templateLanguageCode', '');
      setVal('templateTopicsJson', '[]');
      setVal('templateVariantHintsJson', '');
      setVal('templateInstructions', '');
      setVal('templateBodyTemplate', '');
    }

    async function saveTemplate(event) {
      const btn = event?.target;
      if (btn) { btn.disabled = true; btn.innerHTML = '<span class="loading"></span> Saving...'; }
      try {
        const id = document.getElementById('templateId')?.value || '';
        const body = {
          name: document.getElementById('templateName')?.value?.trim() || 'Default template',
          enabled: !!document.getElementById('templateEnabled')?.checked,
          priority: parseInt(document.getElementById('templatePriority')?.value || '0'),
          ratingMin: parseInt(document.getElementById('templateRatingMin')?.value || '1'),
          ratingMax: parseInt(document.getElementById('templateRatingMax')?.value || '5'),
          sentiment: (() => {
            const s = (document.getElementById('templateSentiment')?.value || '').trim();
            return s.length === 0 ? null : s;
          })(),
          languageCode: (() => {
            const s = (document.getElementById('templateLanguageCode')?.value || '').trim();
            return s.length === 0 ? null : s;
          })(),
          topicsJson: (() => {
            const s = (document.getElementById('templateTopicsJson')?.value || '').trim();
            return s.length === 0 ? null : s;
          })(),
          instructions: (() => {
            const s = (document.getElementById('templateInstructions')?.value || '').trim();
            return s.length === 0 ? null : document.getElementById('templateInstructions')?.value;
          })(),
          bodyTemplate: (() => {
            const s = (document.getElementById('templateBodyTemplate')?.value || '').trim();
            return s.length === 0 ? null : document.getElementById('templateBodyTemplate')?.value;
          })(),
          variantHintsJson: (() => {
            const s = (document.getElementById('templateVariantHintsJson')?.value || '').trim();
            return s.length === 0 ? null : s;
          })(),
        };
        const url = id ? `/api/reply-templates/${encodeURIComponent(id)}` : '/api/reply-templates';
        const method = id ? 'PUT' : 'POST';
        const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data?.success) throw new Error(data?.error || 'Failed to save template');
        await refreshReplyQcConfig(true);
        showSuccess('Template saved', 'Reply QC');
      } catch (e) {
        showError(e.message || 'Failed to save template', 'Reply QC');
      } finally {
        if (btn) { btn.disabled = false; btn.innerHTML = 'üíæ Save Template'; }
      }
    }

    async function deleteTemplate(event) {
      const id = document.getElementById('templateId')?.value || '';
      if (!id) { showWarning('Select a template first', 'Reply QC'); return; }
      if (!confirm('Delete this template?')) return;
      const btn = event?.target;
      if (btn) { btn.disabled = true; btn.innerHTML = '<span class="loading"></span> Deleting...'; }
      try {
        const res = await fetch(`/api/reply-templates/${encodeURIComponent(id)}`, { method: 'DELETE' });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data?.success) throw new Error(data?.error || 'Failed to delete template');
        await refreshReplyQcConfig(true);
        newTemplate();
        showSuccess('Template deleted', 'Reply QC');
      } catch (e) {
        showError(e.message || 'Failed to delete template', 'Reply QC');
      } finally {
        if (btn) { btn.disabled = false; btn.innerHTML = 'üóë Delete Template'; }
      }
    }

    // Notification System
    function showNotification(type, title, message, duration = 5000) {
      const container = document.getElementById('notificationContainer');
      if (!container) return;
      
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      
      const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        info: '‚ÑπÔ∏è',
        warning: '‚ö†Ô∏è'
      };

      notification.innerHTML = `
        <div class="notification-icon">${icons[type] || '‚ÑπÔ∏è'}</div>
        <div class="notification-content">
          <div class="notification-title">${title}</div>
          <div class="notification-message">${message}</div>
        </div>
        <button class="notification-close" onclick="this.parentElement.classList.add('slide-out'); setTimeout(() => this.parentElement.remove(), 300)">√ó</button>
      `;

      container.appendChild(notification);

      // Auto-dismiss after duration
      if (duration > 0) {
        setTimeout(() => {
          notification.classList.add('slide-out');
          setTimeout(() => notification.remove(), 300);
        }, duration);
      }

      return notification;
    }

    // Helper functions for common notifications
    function showSuccess(message, title = 'Success') {
      showNotification('success', title, message);
    }

    function showError(message, title = 'Error') {
      showNotification('error', title, message, 7000); // Errors stay longer
    }

    function showInfo(message, title = 'Info') {
      showNotification('info', title, message);
    }

    function showWarning(message, title = 'Warning') {
      showNotification('warning', title, message);
    }

    function toggleNavItem(itemId) {
      const item = document.getElementById(itemId);
      if (item) {
        item.classList.toggle('expanded');
      }
    }

    function showTab(tabName, event) {
      // Hide all tab content
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Update sidebar navigation active states
      document.querySelectorAll('.nav-submenu .nav-link, .nav-item > .nav-link').forEach(link => {
        link.classList.remove('active');
      });
      
      // Show/hide stats grid based on tab
      const statsGrid = document.getElementById('statsGrid');
      if (statsGrid) {
        statsGrid.style.display = (tabName === 'reviews') ? 'grid' : 'none';
      }
      
      // Show selected tab
      document.getElementById(tabName).classList.add('active');
      
      // Update active state in sidebar
      const activeNavLink = document.querySelector(`.nav-submenu .nav-link[data-tab="${tabName}"], .nav-item > .nav-link[data-tab="${tabName}"]`);
      if (activeNavLink) {
        activeNavLink.classList.add('active');
      }
      
      // Close profile dropdown if open
      const profileDropdown = document.getElementById('profileDropdown');
      if (profileDropdown) {
        profileDropdown.classList.remove('open');
      }

      // Load data for specific tabs
      if (tabName === 'trends') {
        viewTrends();
      } else if (tabName === 'posts') {
        listPosts();
      } else if (tabName === 'competitive') {
        loadCompetitive();
      } else if (tabName === 'team') {
        loadTeam();
      } else if (tabName === 'campaigns') {
        loadCampaignPractice();
      }
    }

    async function loadCompetitive() {
      try {
        // Load with current radius from input (default 10)
        const radiusMiles = parseInt(document.getElementById('compRadius')?.value || '10');
        await loadCompetitiveList(radiusMiles);
      } catch (e) {
        // non-fatal
      }
    }

    // Global map instance
    let competitiveMapInstance = null;
    let competitiveMapMarkers = [];
    let competitiveMapCircle = null;
    let competitiveBusinessMarker = null; // Green marker for business location
    let competitiveFilteredCompetitors = []; // Store filtered competitors for list
    let competitorCurrentPage = 1;
    const competitorItemsPerPage = 10;
    let businessLocationCoords = null; // Store business location coordinates
    
    // Community mapping layers
    let communityPointMarkers = [];
    let demographicHeatmapLayer = null;
    let demographicHeatmapData = null;
    let activeLayers = {
      competitors: true,
      employers: true,
      hospitals: true,
      schools: true,
      demographicsIncome: false,
      demographicsPopulation: false,
    };
    let currentDemographicData = null;

    async function loadCompetitiveList(radiusMiles = null) {
      const listEl = document.getElementById('competitiveList');
      if (listEl) listEl.innerHTML = '<div style="color:#666;">Loading...</div>';
      try {
        const res = await fetch('/api/competitive/competitors');
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data?.success) throw new Error(data?.error || 'Failed to load competitors');
        const competitors = Array.isArray(data.competitors) ? data.competitors : [];
        if (competitors.length === 0) {
          competitiveFilteredCompetitors = [];
          if (listEl) listEl.innerHTML = '<div style="color:#666;">No competitors yet. Use "Discover" above.</div>';
          // Show map with placeholder
          await initializeCompetitiveMap([], radiusMiles);
          return;
        }
        
        // Reset pagination when loading new competitors
        competitorCurrentPage = 1;
        
        // Initialize/update map with competitors and radius
        // The map will filter and render the list via renderCompetitorList
        try {
          const currentRadius = radiusMiles || parseInt(document.getElementById('compRadius')?.value || '10');
          await initializeCompetitiveMap(competitors, currentRadius);
        } catch (mapError) {
          console.error('Error initializing map:', mapError);
          // If map fails, still render list with all competitors
          competitiveFilteredCompetitors = competitors;
          renderCompetitorList(competitors);
        }
      } catch (e) {
        console.error('Error loading competitive list:', e);
        if (listEl) listEl.innerHTML = `<div style="color:#b42318;">${escapeHtml(e.message || 'Failed to load competitors')}</div>`;
      }
    }

    async function initializeCompetitiveMap(competitors, radiusMiles = null, centerLatLng = null) {
      const splitView = document.getElementById('competitiveSplitView');
      const mapEl = document.getElementById('competitiveMap');
      if (!splitView || !mapEl) return;

      // Filter competitors with valid coordinates
      const competitorsWithCoords = competitors.filter(c => 
        c.latitude != null && c.longitude != null && 
        typeof c.latitude === 'number' && typeof c.longitude === 'number'
      );
      
      // Deduplicate competitors by name similarity
      const deduplicatedCompetitors = deduplicateCompetitors(competitorsWithCoords);

      // Fetch business location coordinates if not already cached
      if (!businessLocationCoords) {
        try {
          const res = await fetch('/api/competitive/business-location');
          const data = await res.json().catch(() => ({}));
          if (data?.success && data?.coordinates) {
            businessLocationCoords = data.coordinates;
          }
        } catch (e) {
          console.warn('Could not fetch business location:', e);
        }
      }

      // Show split view (it's always visible now)
      splitView.style.display = 'flex';

      // If no competitors with coordinates, show placeholder
      if (deduplicatedCompetitors.length === 0) {
        mapEl.innerHTML = '<div style="width:100%; height:600px; background:#f0f0f0; display:flex; align-items:center; justify-content:center; color:#666; border-radius:8px;">No competitors with coordinates yet. Discover competitors to see them on the map.</div>';
        // Clear map instance and circle
        if (competitiveMapInstance) {
          competitiveMapInstance = null;
        }
        if (competitiveMapCircle) {
          competitiveMapCircle = null;
        }
        competitiveMapMarkers = [];
        return;
      }

      // Restore map element structure if it was replaced with placeholder
      // Clear any placeholder content and restore styles
      if (mapEl.innerHTML && (mapEl.innerHTML.includes('No competitors') || mapEl.innerHTML.includes('Map will appear'))) {
        mapEl.innerHTML = '';
      }
      // Ensure map container has proper styles
      mapEl.style.width = '100%';
      mapEl.style.height = '600px';
      mapEl.style.borderRadius = '8px';
      mapEl.style.overflow = 'hidden';
      mapEl.style.background = 'transparent';

      // Check if Google Maps API is loaded
      if (typeof google === 'undefined' || !google.maps) {
        // Load Google Maps API key from backend
        fetch('/api/config/maps-key')
          .then(res => res.json())
          .then(data => {
            if (!data.apiKey) {
              console.error('Google Maps API key not configured');
              return;
            }
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${data.apiKey}&libraries=places,visualization`;
            script.async = true;
            script.defer = true;
            script.onload = () => createMapWithMarkers(deduplicatedCompetitors, mapEl, radiusMiles, centerLatLng);
            document.head.appendChild(script);
          })
          .catch(err => {
            console.error('Failed to load Google Maps API key:', err);
          });
      } else {
        createMapWithMarkers(deduplicatedCompetitors, mapEl, radiusMiles, centerLatLng);
      }
    }
    
    // Deduplicate competitors by name similarity
    function deduplicateCompetitors(competitors) {
      if (!competitors || competitors.length === 0) return [];
      
      // Filter out orthodontists and other non-general-dentist specialties
      const filteredCompetitors = competitors.filter(comp => {
        const name = (comp.name || '').toLowerCase();
        // Exclude orthodontists, oral surgeons, periodontists, endodontists, etc.
        const excludeTerms = ['orthodont', 'ortho ', 'oral surgery', 'oral surgeon', 'periodont', 'endodont', 'prosthodont', 'pediatric dentist'];
        for (const term of excludeTerms) {
          if (name.includes(term)) {
            return false;
          }
        }
        // Known orthodontist names (specific practices)
        const knownOrthodontists = ['mellas orthodontics', 'mellas ortho'];
        for (const orthoName of knownOrthodontists) {
          if (name.includes(orthoName)) {
            return false;
          }
        }
        // If name is just "Mellas" or starts with "Mellas" and doesn't clearly indicate general dentistry
        if (name.startsWith('mellas') && !name.includes('dental') && !name.includes('dentist')) {
          return false;
        }
        return true;
      });
      
      // Normalize name for comparison (lowercase, remove common words, punctuation)
      const normalizeName = (name) => {
        if (!name) return '';
        return name.toLowerCase()
          .replace(/[&,]/g, ' ')
          .replace(/\s+/g, ' ')
          .replace(/\b(dental|dentist|dentistry|dr|doctor|dds|dmd|practice|clinic|office)\b/gi, '')
          .trim();
      };
      
      // Extract significant words (surnames, practice names) - words 4+ chars (to catch "Pilek", "Goodkin", etc.)
      const extractSignificantWords = (normalized) => {
        return normalized.split(/\s+/).filter(w => w.length >= 4);
      };
      
      // Group by normalized name
      const groups = new Map();
      filteredCompetitors.forEach(comp => {
        const normalized = normalizeName(comp.name);
        if (!normalized) {
          // If no name, use placeId as key
          const key = comp.placeId || comp.id;
          if (!groups.has(key)) {
            groups.set(key, []);
          }
          groups.get(key).push(comp);
          return;
        }
        
        // Check if similar name already exists (fuzzy matching)
        let found = false;
        const normWords = extractSignificantWords(normalized);
        
        for (const [key, group] of groups.entries()) {
          // Exact match
          if (key === normalized) {
            group.push(comp);
            found = true;
            break;
          }
          
          // Check if names share significant words (surnames, practice names)
          const keyWords = extractSignificantWords(key);
          const commonWords = keyWords.filter(w => normWords.includes(w));
          
          // Match if they share at least one significant word (for cases like "Pilek Jared" and "Goodkin and Pilek")
          // This will match "pilek" in both "pilek jared" and "goodkin pilek"
          if (commonWords.length >= 1) {
            // Always match if they share a significant word (5+ chars like "Pilek", "Goodkin")
            // This ensures "Pilek Jared" matches "Goodkin and Pilek"
            const hasLongCommonWord = commonWords.some(w => w.length >= 5);
            if (hasLongCommonWord || keyWords.length <= 2 || normWords.length <= 2 || commonWords.length >= 2) {
              group.push(comp);
              found = true;
              break;
            }
          }
          
          // Check if one name contains the other (for cases like "Goodkin and Pilek" vs "Goodkin & Pilek")
          if ((normalized.length > 5 && key.includes(normalized.substring(0, Math.min(8, normalized.length)))) ||
              (key.length > 5 && normalized.includes(key.substring(0, Math.min(8, key.length))))) {
            group.push(comp);
            found = true;
            break;
          }
        }
        
        if (!found) {
          groups.set(normalized, [comp]);
        }
      });
      
      // Return first competitor from each group (prefer one with more complete data)
      const deduplicated = [];
      groups.forEach(group => {
        if (group.length === 1) {
          deduplicated.push(group[0]);
        } else {
          // If multiple, prefer the one with address or more complete name
          const sorted = group.sort((a, b) => {
            if (a.address && !b.address) return -1;
            if (!a.address && b.address) return 1;
            // Prefer longer/more complete names
            const aNameLen = (a.name || '').length;
            const bNameLen = (b.name || '').length;
            if (aNameLen !== bNameLen) return bNameLen - aNameLen;
            return 0;
          });
          deduplicated.push(sorted[0]);
        }
      });
      
      return deduplicated;
    }

    function createMapWithMarkers(competitors, mapEl, radiusMiles = null, centerLatLng = null) {
      if (!competitors || competitors.length === 0) return;

      // Calculate bounds to fit all markers
      const bounds = new google.maps.LatLngBounds();
      const markers = [];

      // Determine center - prioritize business location, then provided center, then average of competitors
      let center = centerLatLng;
      if (!center && businessLocationCoords && businessLocationCoords.latitude && businessLocationCoords.longitude) {
        // Use business location as center (for radius circle)
        center = { lat: businessLocationCoords.latitude, lng: businessLocationCoords.longitude };
      } else if (!center && competitors.length > 0) {
        // Calculate average center from competitors
        const avgLat = competitors.reduce((sum, c) => sum + c.latitude, 0) / competitors.length;
        const avgLng = competitors.reduce((sum, c) => sum + c.longitude, 0) / competitors.length;
        center = { lat: avgLat, lng: avgLng };
      } else if (!center && competitors.length === 1) {
        center = { lat: competitors[0].latitude, lng: competitors[0].longitude };
      }

      // Create or reuse map instance
      if (!competitiveMapInstance) {
        competitiveMapInstance = new google.maps.Map(mapEl, {
          zoom: 12,
          center: center || { lat: competitors[0].latitude, lng: competitors[0].longitude },
          mapTypeControl: true,
          streetViewControl: false,
          fullscreenControl: true,
        });
        setupMapClickListener();
      }

      // Clear existing markers and circle
      competitiveMapMarkers.forEach(m => m.setMap(null));
      competitiveMapMarkers = [];
      if (competitiveMapCircle) {
        competitiveMapCircle.setMap(null);
        competitiveMapCircle = null;
      }
      if (competitiveBusinessMarker) {
        competitiveBusinessMarker.setMap(null);
        competitiveBusinessMarker = null;
      }

      // Calculate distance using Haversine formula (shared function)
      const calculateDistance = (lat1, lng1, lat2, lng2) => {
        const R = 6371; // Earth radius in km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLng / 2) * Math.sin(dLng / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c; // Distance in km
      };
      
      // Filter competitors by radius if center and radius are provided
      let competitorsInRadius = competitors;
      if (center && radiusMiles && typeof radiusMiles === 'number' && radiusMiles > 0) {
        const radiusMeters = radiusMiles * 1609.34; // Convert miles to meters
        const radiusKm = radiusMiles * 1.60934; // Convert miles to km for haversine
        
        competitorsInRadius = competitors.filter(comp => {
          if (!comp.latitude || !comp.longitude) return false;
          const distance = calculateDistance(center.lat, center.lng, comp.latitude, comp.longitude);
          return distance <= radiusKm;
        });
        
        // Add radius circle
        competitiveMapCircle = new google.maps.Circle({
          strokeColor: '#667eea',
          strokeOpacity: 0.6,
          strokeWeight: 2,
          fillColor: '#667eea',
          fillOpacity: 0.15,
          map: competitiveMapInstance,
          center: center,
          radius: radiusMeters,
        });
      }
      
      // Sort competitors by distance from business (nearest first)
      // calculateDistance is already defined above
      let sortedCompetitors = competitorsInRadius;
      if (businessLocationCoords && businessLocationCoords.latitude && businessLocationCoords.longitude) {
        sortedCompetitors = competitorsInRadius.map(comp => ({
          ...comp,
          distanceFromBusiness: calculateDistance(
            businessLocationCoords.latitude,
            businessLocationCoords.longitude,
            comp.latitude,
            comp.longitude
          )
        })).sort((a, b) => (a.distanceFromBusiness || Infinity) - (b.distanceFromBusiness || Infinity));
      }
      
      // Store filtered and sorted competitors globally for list rendering
      competitiveFilteredCompetitors = sortedCompetitors;
      
      // Add business location marker (green) if coordinates available
      if (businessLocationCoords && businessLocationCoords.latitude && businessLocationCoords.longitude) {
        const businessPosition = { lat: businessLocationCoords.latitude, lng: businessLocationCoords.longitude };
        bounds.extend(businessPosition);
        
        competitiveBusinessMarker = new google.maps.Marker({
          position: businessPosition,
          map: competitiveMapInstance,
          title: 'Your Business',
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 10,
            fillColor: '#10b981', // Green
            fillOpacity: 1,
            strokeColor: '#ffffff',
            strokeWeight: 2,
          },
          label: {
            text: '‚òÖ',
            color: 'white',
            fontSize: '14px',
            fontWeight: 'bold',
          },
          zIndex: 1000, // Ensure it's on top
        });
        
        const businessInfoWindow = new google.maps.InfoWindow({
          content: `
            <div style="padding: 8px; max-width: 250px;">
              <strong style="font-size: 14px; display: block; margin-bottom: 4px; color: #10b981;">‚òÖ Your Business</strong>
            </div>
          `,
        });
        
        competitiveBusinessMarker.addListener('click', () => {
          businessInfoWindow.open(competitiveMapInstance, competitiveBusinessMarker);
        });
      }
      
      // Create markers for each competitor (only those in radius, sorted by distance)
      sortedCompetitors.forEach((comp, index) => {
        const position = { lat: comp.latitude, lng: comp.longitude };
        bounds.extend(position);

        const marker = new google.maps.Marker({
          position: position,
          map: competitiveMapInstance,
          title: comp.name || comp.placeId,
          label: {
            text: String(index + 1), // Sequential numbers starting from 1
            color: 'white',
            fontSize: '12px',
            fontWeight: 'bold',
          },
        });

        // Create info window
        const infoWindow = new google.maps.InfoWindow({
          content: `
            <div style="padding: 8px; max-width: 250px;">
              <strong style="font-size: 14px; display: block; margin-bottom: 4px;">${escapeHtml(comp.name || comp.placeId)}</strong>
              ${comp.address ? `<div style="font-size: 12px; color: #666; margin-bottom: 4px;">${escapeHtml(comp.address)}</div>` : ''}
              ${comp.phone ? `<div style="font-size: 12px; color: #666;">${escapeHtml(comp.phone)}</div>` : ''}
            </div>
          `,
        });

        marker.addListener('click', () => {
          // Close other info windows
          competitiveMapMarkers.forEach(m => {
            if (m.infoWindow) m.infoWindow.close();
          });
          infoWindow.open(competitiveMapInstance, marker);
        });

        marker.infoWindow = infoWindow;
        marker.pointType = 'competitor';
        competitiveMapMarkers.push(marker);
      });

      // Fit map to show radius circle and all markers
      let circleBounds = null;
      if (competitiveMapCircle) {
        circleBounds = competitiveMapCircle.getBounds();
        if (circleBounds) {
          // Always include circle bounds to ensure radius is visible
          bounds.union(circleBounds);
        }
      }

      // Update map view - prioritize fitting circle if it exists
      if (competitiveMapCircle && circleBounds) {
        // Fit bounds to include circle and markers with padding
        competitiveMapInstance.fitBounds(bounds, { padding: 50 });
      } else if (competitiveMapMarkers.length > 0) {
        if (competitiveMapMarkers.length > 1) {
          // Fit bounds with padding for better view
          competitiveMapInstance.fitBounds(bounds, { padding: 50 });
        } else if (competitiveMapMarkers.length === 1) {
          competitiveMapInstance.setCenter(bounds.getCenter());
          competitiveMapInstance.setZoom(14);
        }
      } else if (competitiveMapCircle && center && radiusMiles) {
        // If no markers but circle exists, center on circle
        competitiveMapInstance.setCenter(center);
        const zoom = Math.min(14, Math.floor(Math.log2(40075 / (radiusMiles * 2))));
        competitiveMapInstance.setZoom(zoom);
      }
      
      // Render competitor list with filtered competitors
      renderCompetitorList(competitiveFilteredCompetitors || competitorsInRadius);
      
      // Load community points if map is initialized
      // Use a small delay to ensure map is fully ready
      if (competitiveMapInstance) {
        setTimeout(() => {
          loadCommunityPointsOnMap();
          loadDemographicData();
          // Auto-load market opportunities
          setTimeout(() => loadMarketOpportunities(), 1000);
        }, 500);
      }
    }
    
    // Load demographic data and create heatmap
    async function loadDemographicData() {
      try {
        console.log('Loading demographic data...');
        const radiusMiles = parseInt(document.getElementById('compRadius')?.value || '10');
        const businessLocation = businessLocationCoords || await getBusinessLocation();
        
        if (!businessLocation) {
          console.warn('No business location available for demographic data');
          return;
        }
        
        const locationStr = `${businessLocation.latitude},${businessLocation.longitude}`;
        const res = await fetch(`/api/competitive/community/demographics?location=${encodeURIComponent(locationStr)}&radiusMiles=${radiusMiles}`);
        const data = await res.json();
        console.log('Demographic data response:', data);
        
        if (data.success && data.demographics && data.demographics.length > 0) {
          currentDemographicData = data.demographics;
          console.log(`Loaded ${data.demographics.length} demographic data points`);
          // Check if any heatmap layer is active, if so update
          if (activeLayers.demographicsIncome || activeLayers.demographicsPopulation) {
            updateDemographicHeatmap();
          }
        } else {
          console.warn('No demographic data returned:', data);
        }
      } catch (e) {
        console.error('Failed to load demographic data:', e);
      }
    }
    
    // Update demographic heatmap based on active layer
    function updateDemographicHeatmap() {
      console.log('updateDemographicHeatmap called', {
        hasMap: !!competitiveMapInstance,
        hasData: !!currentDemographicData,
        dataLength: currentDemographicData?.length || 0,
        activeLayers
      });
      
      if (!competitiveMapInstance) {
        console.warn('Map instance not ready for heatmap');
        return;
      }
      
      // Check if visualization library is loaded
      if (typeof google === 'undefined' || !google.maps || !google.maps.visualization) {
        console.error('Google Maps Visualization library not loaded');
        return;
      }
      
      if (!currentDemographicData || currentDemographicData.length === 0) {
        console.warn('No demographic data available for heatmap');
        return;
      }
      
      // Remove existing heatmap
      if (demographicHeatmapLayer) {
        demographicHeatmapLayer.setMap(null);
        demographicHeatmapLayer = null;
      }
      
      // Determine which metric to show
      let metric = null;
      if (activeLayers.demographicsIncome) {
        metric = 'income';
      } else if (activeLayers.demographicsPopulation) {
        metric = 'population';
      }
      
      if (!metric) {
        console.log('No heatmap metric active');
        return;
      }
      
      console.log(`Creating ${metric} heatmap with ${currentDemographicData.length} data points`);
      
      // Create weighted heatmap data points
      const heatmapData = [];
      let maxValue = 0;
      let minValue = Infinity;
      
      for (const d of currentDemographicData) {
        const value = metric === 'income' ? (d.householdIncome || 0) : (d.population || 0);
        if (value > 0) {
          maxValue = Math.max(maxValue, value);
          minValue = Math.min(minValue, value);
          heatmapData.push({
            location: new google.maps.LatLng(d.latitude, d.longitude),
            weight: value
          });
        }
      }
      
      if (heatmapData.length === 0) {
        console.warn(`No valid ${metric} data points found`);
        return;
      }
      
      console.log(`Heatmap data: ${heatmapData.length} points, range: ${minValue} - ${maxValue}`);
      
      // Normalize weights for better visualization (optional - Google Maps handles this)
      // For now, use raw values and let Google Maps normalize
      
      try {
        // Create heatmap layer with weighted data
        demographicHeatmapLayer = new google.maps.visualization.HeatmapLayer({
          data: heatmapData,
          map: competitiveMapInstance,
          radius: 80, // Increased radius for better visibility
          opacity: 0.7,
          maxIntensity: maxValue, // Set max intensity for better contrast
          gradient: metric === 'income' 
            ? [
                'rgba(0, 255, 0, 0)',
                'rgba(0, 255, 0, 0.5)',
                'rgba(255, 255, 0, 0.7)',
                'rgba(255, 165, 0, 0.9)',
                'rgba(255, 0, 0, 1)'
              ]
            : [
                'rgba(0, 0, 255, 0)',
                'rgba(0, 0, 255, 0.5)',
                'rgba(0, 255, 255, 0.7)',
                'rgba(255, 255, 0, 0.9)',
                'rgba(255, 0, 0, 1)'
              ],
        });
        
        console.log('Heatmap layer created successfully');
        demographicHeatmapData = currentDemographicData;
      } catch (err) {
        console.error('Failed to create heatmap layer:', err);
      }
    }
    
    // Load community points and add to map
    async function loadCommunityPointsOnMap() {
      try {
        console.log('Loading community points...');
        const res = await fetch('/api/competitive/community/points');
        const data = await res.json();
        console.log('Community points response:', data);
        if (data.success && data.points && data.points.length > 0) {
          console.log(`Found ${data.points.length} community points`);
          addCommunityPointsToMap(data.points);
        } else {
          console.log('No community points found or request failed:', data);
        }
      } catch (e) {
        console.error('Failed to load community points:', e);
      }
    }
    
    // Add community points to map with different icons
    function addCommunityPointsToMap(points) {
      if (!competitiveMapInstance) {
        console.warn('Map instance not ready for community points');
        return;
      }
      
      if (!points || points.length === 0) {
        console.log('No community points to add');
        return;
      }
      
      // Clear existing community markers
      communityPointMarkers.forEach(m => m.setMap(null));
      communityPointMarkers = [];
      
      // Icon colors by type
      const iconConfig = {
        employer: { color: '#3b82f6', path: google.maps.SymbolPath.CIRCLE, scale: 8 },
        hospital: { color: '#ef4444', path: google.maps.SymbolPath.CIRCLE, scale: 8 },
        school: { color: '#10b981', path: google.maps.SymbolPath.CIRCLE, scale: 8 },
        poi: { color: '#8b5cf6', path: google.maps.SymbolPath.CIRCLE, scale: 6 },
      };
      
      let addedCount = 0;
      for (const point of points) {
        // Validate point data
        if (!point.latitude || !point.longitude || !point.type) {
          console.warn('Invalid community point:', point);
          continue;
        }
        
        // Check if layer is enabled
        const layerKey = point.type === 'employer' ? 'employers' : 
                        point.type === 'hospital' ? 'hospitals' : 
                        point.type === 'school' ? 'schools' : 'competitors';
        if (!activeLayers[layerKey]) {
          console.log(`Layer ${layerKey} is disabled, skipping ${point.name}`);
          continue;
        }
        
        const config = iconConfig[point.type] || iconConfig.poi;
        try {
          const marker = new google.maps.Marker({
            position: { lat: point.latitude, lng: point.longitude },
            map: competitiveMapInstance,
            title: point.name,
            icon: {
              path: config.path,
              fillColor: config.color,
              fillOpacity: 0.8,
              strokeColor: '#ffffff',
              strokeWeight: 2,
              scale: config.scale,
            },
          });
          
          const infoWindow = new google.maps.InfoWindow({
            content: `
              <div style="padding: 8px; min-width: 200px;">
                <h4 style="margin: 0 0 8px 0; font-size: 14px; font-weight: 600;">${escapeHtml(point.name)}</h4>
                <p style="margin: 0 0 4px 0; font-size: 12px; color: #666;">${escapeHtml(point.category || point.type)}</p>
                <p style="margin: 0; font-size: 11px; color: #999;">${escapeHtml(point.address || '')}</p>
                ${point.metadata ? `<p style="margin: 4px 0 0 0; font-size: 11px; color: #666;">${JSON.stringify(point.metadata)}</p>` : ''}
              </div>
            `,
          });
          
          marker.addListener('click', () => {
            communityPointMarkers.forEach(m => {
              if (m.infoWindow) m.infoWindow.close();
            });
            infoWindow.open(competitiveMapInstance, marker);
          });
          
          marker.infoWindow = infoWindow;
          marker.pointType = point.type;
          communityPointMarkers.push(marker);
          addedCount++;
        } catch (err) {
          console.error('Failed to create marker for point:', point, err);
        }
      }
      
      console.log(`Added ${addedCount} community point markers to map (total points: ${points.length})`);
      
      // Update map bounds to include community points if needed
      if (addedCount > 0 && competitiveMapInstance) {
        const bounds = new google.maps.LatLngBounds();
        communityPointMarkers.forEach(m => {
          if (m.getPosition()) {
            bounds.extend(m.getPosition());
          }
        });
        // Only adjust bounds if we have markers
        if (!bounds.isEmpty()) {
          // Extend existing bounds if there are competitor markers
          competitiveMapMarkers.forEach(m => {
            if (m.getPosition()) {
              bounds.extend(m.getPosition());
            }
          });
          competitiveMapInstance.fitBounds(bounds, { padding: 50 });
        }
      }
    }
    
    // Toggle map layer visibility
    function toggleMapLayer(layer, visible) {
      activeLayers[layer] = visible;
      
      if (layer === 'competitors') {
        competitiveMapMarkers.forEach(m => m.setMap(visible ? competitiveMapInstance : null));
      } else if (layer === 'employers' || layer === 'hospitals' || layer === 'schools') {
        // Filter community markers by type
        const typeMap = {
          employers: 'employer',
          hospitals: 'hospital',
          schools: 'school',
        };
        const targetType = typeMap[layer];
        if (!targetType) {
          console.warn('Unknown layer type:', layer);
          return;
        }
        let toggledCount = 0;
        communityPointMarkers.forEach(m => {
          if (m.pointType === targetType) {
            m.setMap(visible ? competitiveMapInstance : null);
            toggledCount++;
          }
        });
        console.log(`Toggled ${toggledCount} ${layer} markers (visible: ${visible})`);
        // If we just enabled a layer but no markers are showing, reload community points
        if (visible && toggledCount === 0 && communityPointMarkers.length === 0) {
          console.log('Layer enabled but no markers found, reloading community points...');
          loadCommunityPointsOnMap();
        }
      } else if (layer === 'demographicsIncome' || layer === 'demographicsPopulation') {
        // Toggle heatmap
        console.log(`Toggling ${layer} heatmap: ${visible}`);
        if (visible) {
          // If other demographic layer is active, turn it off
          if (layer === 'demographicsIncome') {
            activeLayers.demographicsPopulation = false;
            const popCheckbox = document.getElementById('layerDemographicsPopulation');
            if (popCheckbox) popCheckbox.checked = false;
          } else {
            activeLayers.demographicsIncome = false;
            const incomeCheckbox = document.getElementById('layerDemographicsIncome');
            if (incomeCheckbox) incomeCheckbox.checked = false;
          }
          // Ensure demographic data is loaded before creating heatmap
          if (!currentDemographicData || currentDemographicData.length === 0) {
            console.log('No demographic data loaded, loading now...');
            loadDemographicData().then(() => {
              // Small delay to ensure data is set
              setTimeout(() => updateDemographicHeatmap(), 100);
            });
          } else {
            updateDemographicHeatmap();
          }
        } else {
          if (demographicHeatmapLayer) {
            demographicHeatmapLayer.setMap(null);
            demographicHeatmapLayer = null;
            console.log('Heatmap layer removed');
          }
        }
      }
    }
    
    // Discover community points
    async function discoverCommunityPoints() {
      try {
        const radiusMiles = parseInt(document.getElementById('compRadius')?.value || '10');
        const businessLocation = businessLocationCoords || await getBusinessLocation();
        
        if (!businessLocation) {
          alert('Business location is required. Please set your business address first.');
          return;
        }
        
        const button = event?.target;
        if (button) {
          button.disabled = true;
          button.textContent = 'Discovering...';
        }
        
        const res = await fetch('/api/competitive/community/discover', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            location: businessLocation,
            radiusMiles,
            forceRefresh: false,
          }),
        });
        
        const data = await res.json();
        if (data.success) {
          alert(`Discovered ${data.upserted} community points!`);
          await loadCommunityPointsOnMap();
        } else {
          throw new Error(data.error || 'Failed to discover community points');
        }
      } catch (e) {
        console.error('Failed to discover community points:', e);
        alert('Failed to discover community points: ' + (e.message || 'Unknown error'));
      } finally {
        const button = event?.target;
        if (button) {
          button.disabled = false;
          button.textContent = 'üîç Discover Community';
        }
      }
    }
    
    // Get business location coordinates
    async function getBusinessLocation() {
      try {
        const res = await fetch('/api/competitive/business-location');
        const data = await res.json();
        if (data.success && data.location) {
          return {
            latitude: data.location.latitude,
            longitude: data.location.longitude,
          };
        }
      } catch (e) {
        console.error('Failed to get business location:', e);
      }
      return null;
    }
    
    function renderCompetitorList(competitors) {
      const listEl = document.getElementById('competitiveList');
      const countEl = document.getElementById('competitorCount');
      const paginationEl = document.getElementById('competitivePagination');
      if (!listEl) return;
      
      const totalCompetitors = competitors.length;
      if (countEl) {
        countEl.textContent = `(${totalCompetitors})`;
      }
      
      if (totalCompetitors === 0) {
        listEl.innerHTML = '<div style="color:#666;">No competitors within the search radius.</div>';
        if (paginationEl) paginationEl.style.display = 'none';
        return;
      }
      
      // Calculate pagination
      const totalPages = Math.ceil(totalCompetitors / competitorItemsPerPage);
      const startIndex = (competitorCurrentPage - 1) * competitorItemsPerPage;
      const endIndex = Math.min(startIndex + competitorItemsPerPage, totalCompetitors);
      const pageCompetitors = competitors.slice(startIndex, endIndex);
      
      // Render competitors with numbering matching map markers
      const rows = pageCompetitors.map((c, idx) => {
        const number = startIndex + idx + 1; // Match map marker numbers
        const name = escapeHtml(c.name || c.placeId);
        const addr = escapeHtml(c.address || '');
        const status = escapeHtml(c.status || 'active');
        const locked = !!c.locked;
        const badgeCls = status === 'active' ? 'badge-success' : 'badge-warning';
        return `
          <div class="review-item" style="margin-bottom: 12px;">
            <div class="review-header">
              <div style="min-width:0; display:flex; align-items:center; gap:10px;">
                <span style="background:#667eea; color:white; width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:12px; flex-shrink:0;">${number}</span>
                <div style="min-width:0;">
                  <div style="font-weight:800;">${name}</div>
                  <div class="small-muted" style="word-break:break-word;">${addr}</div>
                  ${c.distanceFromBusiness != null ? `<div class="small-muted" style="font-size:0.85em; color:#10b981; margin-top:2px;">üìç ${c.distanceFromBusiness.toFixed(1)} km away</div>` : ''}
                </div>
              </div>
              <div>
                <span class="badge ${badgeCls}">${status}</span>
                <span class="badge badge-info">${locked ? 'locked' : 'unlocked'}</span>
              </div>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px;">
              <button class="btn btn-secondary btn-sm" onclick="showCompetitorInsights('${c.id}')">üìà View insights</button>
              <button class="btn btn-secondary btn-sm" onclick="toggleCompetitorLock('${c.id}', ${locked ? 'false' : 'true'})">${locked ? 'üîì Unlock' : 'üîí Lock'}</button>
              <button class="btn btn-secondary btn-sm" onclick="toggleCompetitorStatus('${c.id}', '${status === 'active' ? 'hidden' : 'active'}')">${status === 'active' ? 'üôà Hide' : 'üëÅÔ∏è Activate'}</button>
            </div>
          </div>
        `;
      }).join('');
      listEl.innerHTML = rows;
      
      // Show/hide pagination
      if (totalPages > 1 && paginationEl) {
        paginationEl.style.display = 'flex';
        const pageInfoEl = document.getElementById('pageInfo');
        if (pageInfoEl) {
          pageInfoEl.textContent = `Page ${competitorCurrentPage} of ${totalPages} (${startIndex + 1}-${endIndex} of ${totalCompetitors})`;
        }
        const prevBtn = document.getElementById('prevPage');
        const nextBtn = document.getElementById('nextPage');
        if (prevBtn) prevBtn.disabled = competitorCurrentPage === 1;
        if (nextBtn) nextBtn.disabled = competitorCurrentPage === totalPages;
      } else if (paginationEl) {
        paginationEl.style.display = 'none';
      }
    }
    
    function changeCompetitorPage(direction) {
      const totalCompetitors = competitiveFilteredCompetitors.length;
      const totalPages = Math.ceil(totalCompetitors / competitorItemsPerPage);
      const newPage = competitorCurrentPage + direction;
      if (newPage >= 1 && newPage <= totalPages) {
        competitorCurrentPage = newPage;
        renderCompetitorList(competitiveFilteredCompetitors);
      }
    }

    async function discoverCompetitorsUi(event) {
      const btn = event?.target;
      if (btn) btn.disabled = true;
      try {
        const query = document.getElementById('compQuery')?.value?.trim();
        const radiusMiles = parseInt(document.getElementById('compRadius')?.value || '10');
        const limit = parseInt(document.getElementById('compLimit')?.value || '10');
        if (!query) throw new Error('Query is required');
        const res = await fetch('/api/competitive/discover', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query, radiusMiles, limit }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data?.success) throw new Error(data?.error || 'Discovery failed (Owner/Admin only?)');
        showSuccess(`Discovered/upserted ${data.upserted || 0} competitor(s).`, 'Competitive');
        // Reload list and update map with radius
        await loadCompetitiveList(radiusMiles);
      } catch (e) {
        showError(e.message || 'Discovery failed', 'Competitive');
      } finally {
        if (btn) btn.disabled = false;
      }
    }

    async function refreshCompetitorSnapshot(competitorId) {
      try {
        const res = await fetch('/api/competitive/refresh', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ competitorId }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data?.success) throw new Error(data?.error || 'Failed to refresh snapshot');
        showSuccess(`Snapshot created successfully! Refreshing insights...`, 'Competitive');
        // Reload insights
        await showCompetitorInsights(competitorId);
      } catch (e) {
        showError(e.message || 'Failed to create snapshot', 'Competitive');
      }
    }

    async function refreshCompetitorsUi(event) {
      const btn = event?.target;
      if (btn) btn.disabled = true;
      try {
        const res = await fetch('/api/competitive/refresh', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({}) });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data?.success) throw new Error(data?.error || 'Refresh failed (Owner/Admin only?)');
        showSuccess(`Refresh complete (${data.count || 0} processed).`, 'Competitive');
      } catch (e) {
        showError(e.message || 'Refresh failed', 'Competitive');
      } finally {
        if (btn) btn.disabled = false;
      }
    }

    async function refreshCompetitorCoordinates(event) {
      const btn = event?.target;
      if (btn) btn.disabled = true;
      try {
        const res = await fetch('/api/competitive/refresh-coordinates', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({}),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data?.success) throw new Error(data?.error || 'Failed to refresh coordinates (Owner/Admin only?)');
        const msg = `Coordinates refreshed: ${data.updated || 0} updated, ${data.skipped || 0} skipped, ${data.total || 0} total.`;
        showSuccess(msg, 'Competitive');
        // Reload competitors list to update map
        await loadCompetitiveList();
      } catch (e) {
        showError(e.message || 'Failed to refresh coordinates', 'Competitive');
      } finally {
        if (btn) btn.disabled = false;
      }
    }

    async function toggleCompetitorLock(id, locked) {
      try {
        const res = await fetch(`/api/competitive/competitors/${encodeURIComponent(id)}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ locked }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data?.success) throw new Error(data?.error || 'Update failed');
        await loadCompetitiveList();
      } catch (e) {
        showError(e.message || 'Update failed', 'Competitive');
      }
    }

    async function toggleCompetitorStatus(id, status) {
      try {
        const res = await fetch(`/api/competitive/competitors/${encodeURIComponent(id)}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data?.success) throw new Error(data?.error || 'Update failed');
        await loadCompetitiveList();
      } catch (e) {
        showError(e.message || 'Update failed', 'Competitive');
      }
    }

    async function showCompetitorInsights(id) {
      const card = document.getElementById('competitiveInsightsCard');
      const el = document.getElementById('competitiveInsights');
      if (card) card.style.display = 'block';
      // Scroll to insights card
      setTimeout(() => card?.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 100);
      if (el) el.innerHTML = '<div style="color:#666;">Loading...</div>';
      try {
        const res = await fetch(`/api/competitive/insights?competitorId=${encodeURIComponent(id)}&windowDays=7`);
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          const errorMsg = data?.error || data?.message || `HTTP ${res.status}: ${res.statusText}`;
          console.error('Insights API error:', { status: res.status, data });
          throw new Error(errorMsg);
        }
        if (!data?.success) {
          throw new Error(data?.error || 'Failed to load insights');
        }

        const comp = data.competitor || {};
        const snap = data.latestSnapshot || {};
        const vel = data.velocity?.velocityWindow || {};
        const overlap = data.keywordOverlap || {};
        const themes = Array.isArray(data.themes) ? data.themes : [];
        
        // Parse website analysis if available
        let websiteAnalysis = null;
        if (snap.websiteAnalysisJson) {
          try {
            websiteAnalysis = JSON.parse(snap.websiteAnalysisJson);
          } catch {
            websiteAnalysis = null;
          }
        }

        const themeRows = themes.slice(0, 8).map((t) => {
          const examples = t.examplesJson ? (() => { try { return JSON.parse(t.examplesJson); } catch { return []; } })() : [];
          return `
            <div style="padding:10px 0; border-bottom:1px solid #eee;">
              <div style="font-weight:800;">${escapeHtml(t.theme)} <span class="small-muted">(${escapeHtml(t.sentiment || 'neutral')})</span></div>
              ${examples.length ? `<div class="small-muted">${examples.map((e) => escapeHtml(e)).join(' ‚Ä¢ ')}</div>` : ''}
            </div>
          `;
        }).join('');

        const overlapList = Array.isArray(overlap?.overlap) ? overlap.overlap : [];
        const jacc = typeof overlap?.jaccard === 'number' ? overlap.jaccard : 0;
        // Check if snapshot exists and has actual data (not just empty object)
        const hasSnapshot = snap && Object.keys(snap).length > 0 && (snap.rating != null || snap.userRatingsTotal != null);
        const hasVelocity = vel && (typeof vel.perDay === 'number' || typeof vel.deltaCount === 'number');
        const hasOverlap = overlap && (overlapList.length > 0 || jacc > 0);

        if (el) {
          el.innerHTML = `
            <div class="card" style="box-shadow:none; border:1px solid #eee;">
              <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;">
                <div>
                  <div style="font-weight:900; font-size:1.1rem;">${escapeHtml(comp.name || 'Unknown')}</div>
                  <div class="small-muted">${escapeHtml(comp.address || '')}</div>
                </div>
                <div>
                  ${hasSnapshot ? `
                    <span class="badge badge-primary">Rating: ${typeof snap.rating === 'number' ? snap.rating.toFixed(1) : '‚Äî'}</span>
                    <span class="badge badge-info">Reviews: ${snap.userRatingsTotal ?? '‚Äî'}</span>
                  ` : '<span class="badge badge-warning">No snapshot yet</span>'}
                </div>
              </div>
              ${hasSnapshot ? `
              <div style="margin-top:10px;">
                <span class="badge badge-info">Velocity</span>
                <span class="small-muted">${hasVelocity ? `${typeof vel.perDay === 'number' ? vel.perDay.toFixed(2) : '‚Äî'} reviews/day (Œî ${vel.deltaCount ?? '‚Äî'} over ${vel.deltaDays ? vel.deltaDays.toFixed(1) : '‚Äî'} days)` : '‚Äî (need multiple snapshots)'}</span>
              </div>
              <div style="margin-top:10px;">
                <span class="badge badge-info">Keyword overlap</span>
                <span class="small-muted">${hasOverlap ? `Jaccard: ${(jacc * 100).toFixed(0)}% ‚Ä¢ Overlap: ${overlapList.slice(0, 12).map((k) => escapeHtml(k)).join(', ')}` : '‚Äî (no overlap data)'}</span>
              </div>
              ${snap.websiteRating != null ? `
              <div style="margin-top:10px;">
                <span class="badge badge-info">Website Quality</span>
                <span class="small-muted">${snap.websiteRating}/100</span>
                ${websiteAnalysis ? `
                  <details style="margin-top:8px;" open>
                    <summary style="cursor:pointer; font-weight:700; color:#0066cc;">View detailed analysis</summary>
                    <div style="margin-top:8px; padding:12px; background:#f7f7f7; border-radius:6px; font-size:0.9rem;">
                      <div style="margin-bottom:8px;"><strong>SEO:</strong> ${websiteAnalysis.seo?.score || 0}/30 ${websiteAnalysis.seo?.details?.length ? `‚Ä¢ ${websiteAnalysis.seo.details.slice(0, 2).map((d) => escapeHtml(d)).join(', ')}` : ''}</div>
                      <div style="margin-bottom:8px;"><strong>Content:</strong> ${websiteAnalysis.content?.score || 0}/30 ${websiteAnalysis.content?.details?.length ? `‚Ä¢ ${websiteAnalysis.content.details.slice(0, 2).map((d) => escapeHtml(d)).join(', ')}` : ''}</div>
                      <div style="margin-bottom:8px;"><strong>Features:</strong> ${websiteAnalysis.features?.score || 0}/20 ${websiteAnalysis.features?.details?.length ? `‚Ä¢ ${websiteAnalysis.features.details.slice(0, 2).map((d) => escapeHtml(d)).join(', ')}` : ''}</div>
                      <div style="margin-bottom:8px;"><strong>UX:</strong> ${websiteAnalysis.ux?.score || 0}/20 ${websiteAnalysis.ux?.details?.length ? `‚Ä¢ ${websiteAnalysis.ux.details.slice(0, 2).map((d) => escapeHtml(d)).join(', ')}` : ''}</div>
                      
                      <div style="margin-top:12px; margin-bottom:8px;">
                        <strong style="color:#667eea;">Specialty Services Offered:</strong>
                        ${websiteAnalysis.specialty_services && websiteAnalysis.specialty_services.length > 0 ? `
                          <div style="margin-top:4px; display:flex; flex-wrap:wrap; gap:6px;">
                            ${websiteAnalysis.specialty_services.map((service) => 
                              `<span style="background:#e0e7ff; color:#4338ca; padding:4px 8px; border-radius:4px; font-size:0.85em;">${escapeHtml(service)}</span>`
                            ).join('')}
                          </div>
                        ` : `
                          <div style="margin-top:4px; color:#999; font-size:0.9em;">No specialty services detected. Create a new snapshot to analyze the website for specialty services.</div>
                        `}
                      </div>
                      
                      <div style="margin-top:12px; margin-bottom:8px;">
                        <strong style="color:#10b981;">Insurance Carriers Accepted:</strong>
                        ${websiteAnalysis.insurance_carriers && websiteAnalysis.insurance_carriers.length > 0 ? `
                          <div style="margin-top:4px; display:flex; flex-wrap:wrap; gap:6px;">
                            ${websiteAnalysis.insurance_carriers.map((carrier) => 
                              `<span style="background:#d1fae5; color:#065f46; padding:4px 8px; border-radius:4px; font-size:0.85em;">${escapeHtml(carrier)}</span>`
                            ).join('')}
                          </div>
                        ` : `
                          <div style="margin-top:4px; color:#999; font-size:0.9em;">No insurance information detected. Create a new snapshot to analyze the website for accepted insurance carriers.</div>
                        `}
                      </div>
                      
                      ${websiteAnalysis.recommendations?.length ? `
                        <div style="margin-top:12px;"><strong>Recommendations:</strong>
                          <ul style="margin:6px 0 0 20px; padding:0;">
                            ${websiteAnalysis.recommendations.slice(0, 5).map((r) => `<li style="margin-bottom:4px;">${escapeHtml(r)}</li>`).join('')}
                          </ul>
                        </div>
                      ` : ''}
                    </div>
                  </details>
                ` : ''}
              </div>
              ` : ''}
              <div style="margin-top:14px;">
                <div style="font-weight:900;">Common themes</div>
                ${themeRows || '<div class="small-muted">No themes yet (need snapshots with review text).</div>'}
              </div>
              ` : `
              <div style="margin-top:16px; padding:16px; background:#f7f7f7; border-radius:8px;">
                <div style="margin-bottom:8px; font-weight:800;">No insights data available</div>
                <div class="small-muted" style="margin-bottom:12px;">You need to create snapshots first to generate insights (ratings, velocity, themes, keyword overlap).</div>
                <button class="btn btn-secondary btn-sm" onclick="refreshCompetitorSnapshot('${id}')">üìä Create Snapshot</button>
              </div>
              `}
            </div>
          `;
        }
      } catch (e) {
        console.error('Failed to load competitor insights:', e);
        const errorMsg = e?.message || String(e) || 'Failed to load insights';
        if (el) el.innerHTML = `<div style="color:#b42318;">${escapeHtml(errorMsg)}</div>`;
        showError(errorMsg, 'Competitive Insights');
      }
    }

    async function loadStats() {
      try {
        const res = await fetch('/api/reviews');
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          const msg = data?.error || data?.message || `Failed to load reviews (${res.status})`;
          throw new Error(msg);
        }
        const reviews = Array.isArray(data) ? data : Array.isArray(data?.reviews) ? data.reviews : [];
        const total = reviews.length;
        const average = reviews.reduce((sum, r) => sum + r.rating, 0) / total || 0;
        
        // Check both repliedAt AND status to determine if replied
        // A review is replied if: (repliedAt is set) OR (status === 'Replied')
        const replied = reviews.filter(r => {
          // Normalize - if repliedAt exists or status is Replied, it's replied
          return r.repliedAt || r.status === 'Replied';
        }).length;
        
        // Unreplied = not replied AND not in "Needs Approval" status (those need manual review)
        // Unreplied means: no repliedAt AND status is not 'Replied' AND status is not 'Needs Approval'
        const unreplied = reviews.filter(r => {
          const isReplied = r.repliedAt || r.status === 'Replied';
          const needsApproval = r.status === 'Needs Approval';
          return !isReplied && !needsApproval;
        }).length;

        document.getElementById('totalReviews').textContent = total;
        document.getElementById('averageRating').textContent = average.toFixed(1) + '/5';
        document.getElementById('replyRate').textContent = total > 0 ? ((replied / total) * 100).toFixed(0) + '%' : '0%';
        document.getElementById('unrepliedCount').textContent = unreplied;
        
        // Debug log to verify calculation
        console.log('Stats loaded:', { total, replied, unreplied, average: average.toFixed(1) });
      } catch (error) {
        console.error('Failed to load stats:', error);
      }
    }

    function renderVariantsHtml(review) {
      const v = review && review.replyVariants;
      if (!v || !v.A || !v.B) return '';
      const selected = String(v.selected || '').toUpperCase();
      const badge = selected === 'A' || selected === 'B' ? selected : '‚Äî';
      const qcBadge = (qc) => {
        if (!qc) return '<span class="badge badge-warning">QC unknown</span>';
        if (qc.blocked) return '<span class="badge badge-danger">Blocked</span>';
        return qc.ok ? '<span class="badge badge-success">QC pass</span>' : '<span class="badge badge-warning">QC needs review</span>';
      };
      const shortIssues = (qc) => {
        const issues = Array.isArray(qc?.issues) ? qc.issues : [];
        if (issues.length === 0) return '';
        return `<div class="small-muted" style="margin-top:6px;">${issues.slice(0, 3).map(x => escapeHtml(x)).join(' ‚Ä¢ ')}</div>`;
      };

      return `
        <div style="margin-top: 12px; padding: 12px; border: 1px solid #e6e6ff; border-radius: 8px; background: #f7f7ff;">
          <div style="display:flex; align-items:center; justify-content: space-between; gap: 10px; flex-wrap: wrap;">
            <div>
              <strong>Variants:</strong>
              <span class="badge badge-primary">Selected ${badge}</span>
              ${review.replyLanguageCode ? `<span class="badge badge-info">${escapeHtml(review.replyLanguageCode)}</span>` : ''}
            </div>
            <div style="display:flex; gap: 8px; flex-wrap: wrap;">
              <button class="btn btn-secondary btn-sm" onclick="selectVariant(${review.id}, 'A')">Select A</button>
              <button class="btn btn-secondary btn-sm" onclick="selectVariant(${review.id}, 'B')">Select B</button>
            </div>
          </div>
          <details style="margin-top: 10px;">
            <summary style="cursor:pointer; font-weight:700;">Variant A ${qcBadge(v.A.qc)}</summary>
            <div class="reply-draft" style="margin-top: 8px; white-space: pre-wrap;">${escapeHtml(v.A.text || '')}</div>
            ${shortIssues(v.A.qc)}
          </details>
          <details style="margin-top: 10px;">
            <summary style="cursor:pointer; font-weight:700;">Variant B ${qcBadge(v.B.qc)}</summary>
            <div class="reply-draft" style="margin-top: 8px; white-space: pre-wrap;">${escapeHtml(v.B.text || '')}</div>
            ${shortIssues(v.B.qc)}
          </details>
        </div>
      `;
    }

    async function loadReviews() {
      const status = document.getElementById('filterStatus')?.value || '';
      const rating = document.getElementById('filterRating')?.value || '';
      const sentiment = document.getElementById('filterSentiment')?.value || '';

      try {
        let url = '/api/reviews?';
        const params = new URLSearchParams();
        if (status) params.append('status', status);
        if (rating) params.append('rating', rating);
        if (sentiment) params.append('sentiment', sentiment);
        url += params.toString();

        const res = await fetch(url);
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          const msg = data?.error || data?.message || `Failed to load reviews (${res.status})`;
          // If session expired, bounce to login
          if (res.status === 401) {
            window.location.href = '/login';
            return;
          }
          throw new Error(msg);
        }
        const reviews = Array.isArray(data) ? data : Array.isArray(data?.reviews) ? data.reviews : null;
        const listEl = document.getElementById('reviewsList');

        if (!Array.isArray(reviews)) {
          listEl.innerHTML = `<div class="alert alert-error">Error loading reviews: Unexpected response. Try refreshing, or switch business.</div>`;
          reviewsById = new Map();
          updateBulkToolbar();
          return;
        }

        if (reviews.length === 0) {
          listEl.innerHTML = '<div class="empty-state"><p>No reviews found</p></div>';
          reviewsById = new Map();
          updateBulkToolbar();
          return;
        }

        // Cache for bulk actions / diff view
        reviewsById = new Map();
        (reviews || []).forEach((r) => reviewsById.set(Number(r.id), r));
        updateBulkToolbar();
        updateOverdueApprovals(reviews);

        listEl.innerHTML = reviews.map(review => `
          <div class="review-item">
            <div class="review-header">
              <div>
                <input type="checkbox" id="sel-${review.id}" style="margin-right: 10px;" onchange="toggleReviewSelection(${review.id}, this.checked)" ${selectedReviewIds.has(Number(review.id)) ? 'checked' : ''} />
                <span class="review-author">${review.authorName}</span>
                <span class="review-date"> - ${new Date(review.createTime).toLocaleDateString()}</span>
              </div>
              <div class="review-rating">
                ${'‚òÖ'.repeat(review.rating)}${'‚òÜ'.repeat(5 - review.rating)}
              </div>
            </div>
            ${review.comment ? `<div class="review-comment">${review.comment}</div>` : '<div class="review-comment"><em>No comment</em></div>'}
            <div class="review-analysis">
              <div style="margin-bottom: 10px;">
                <span class="badge badge-${review.sentiment === 'positive' ? 'success' : review.sentiment === 'negative' ? 'danger' : 'warning'}">${review.sentiment || 'Not analyzed'}</span>
                <span class="badge badge-info">${review.urgency || 'N/A'} urgency</span>
                <span class="badge badge-${review.status === 'Replied' ? 'success' : review.status === 'Auto-Approved' ? 'primary' : review.status === 'Needs Approval' ? 'warning' : 'danger'}">${review.status}</span>
                ${review.repliedAt ? `<span class="badge badge-success">Replied ${new Date(review.repliedAt).toLocaleDateString()}</span>` : ''}
              </div>
              ${Array.isArray(review.whyFlagged) && review.whyFlagged.length > 0 ? `
                <div style="margin-bottom: 10px;">
                  <span class="badge badge-warning">Why flagged</span>
                  <span class="small-muted">${review.whyFlagged.map(x => escapeHtml(x)).join(' ‚Ä¢ ')}</span>
                </div>
              ` : ''}
              ${renderAssigneeHtml(review)}
              ${review.replyDraft ? `
                <div class="reply-section">
                  <strong>Reply Draft:</strong>
                  <div class="reply-draft" id="draft-${review.id}">${review.replyDraft}</div>
                  ${renderVariantsHtml(review)}
                  ${!review.repliedAt ? `
                    <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                      <button class="btn" onclick="editReply(${review.id})" style="font-size: 0.9rem; padding: 8px 16px;">‚úèÔ∏è Edit Reply</button>
                      <button class="btn btn-secondary" onclick="openHistory(${review.id})" style="font-size: 0.9rem; padding: 8px 16px;">üïí History</button>
                      <button class="btn btn-secondary" onclick="regenerateReplyForReview(${review.id}, event)" style="font-size: 0.9rem; padding: 8px 16px;" id="regenerateBtn-${review.id}">üîÑ Regenerate Reply</button>
                      ${review.status === 'Auto-Approved' ? `
                        <button class="btn btn-success" onclick="postReplyById(${review.id})" style="font-size: 0.9rem; padding: 8px 16px;">üì§ Post Reply</button>
                      ` : review.status === 'Needs Approval' ? `
                        <button class="btn btn-warning" onclick="approveAndPost(${review.id})" style="font-size: 0.9rem; padding: 8px 16px;">‚úÖ Approve & Post</button>
                      ` : `
                        <button class="btn btn-success" onclick="postReplyById(${review.id})" style="font-size: 0.9rem; padding: 8px 16px;">üì§ Post Reply</button>
                      `}
                    </div>
                  ` : ''}
                </div>
              ` : !review.repliedAt ? `
                <div class="reply-section">
                  <button class="btn" onclick="generateReplyForReview(${review.id})" style="font-size: 0.9rem; padding: 8px 16px;">ü§ñ Generate Reply</button>
                </div>
              ` : ''}
            </div>
          </div>
        `).join('');
      } catch (error) {
        document.getElementById('reviewsList').innerHTML = `<div class="alert alert-error">Error loading reviews: ${error.message}</div>`;
      }
    }

    async function selectVariant(reviewId, selected) {
      try {
        const res = await fetch(`/api/reviews/${reviewId}/select-variant`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ selected }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || 'Failed to select variant');
        showSuccess(`Selected variant ${selected} and updated reply draft.`, 'Variant Selected');
        await loadReviews();
      } catch (e) {
        showError(e.message || 'Failed to select variant', 'Variant Selection Error');
      }
    }

    async function fetchNewReviews(event) {
      const btn = event.target;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> Fetching...';

      try {
        const response = await fetch('/api/reviews/fetch', { method: 'POST' });
        const data = await response.json();
        
        if (response.ok) {
          const message = data.message || `Fetched ${data.count || 0} new reviews! Processed ${data.processed || 0}, analyzed ${data.analyzed || 0}.`;
          showSuccess(message, 'Reviews Updated');
          loadReviews();
          loadStats();
        } else {
          const errorMsg = data.message || data.error || 'Failed to fetch reviews';
          showError(errorMsg, 'Fetch Error');
        }
      } catch (error) {
        const errorMsg = error.message || 'Network error - could not connect to server';
        showError(errorMsg, 'Fetch Error');
        console.error('Fetch error:', error);
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'üì• Fetch New Reviews';
      }
    }

    async function analyzeAllUnreplied() {
      if (!confirm('This will analyze all unreplied reviews and generate reply drafts. This may take a few minutes. Continue?')) {
        return;
      }

      const btn = event.target;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> Analyzing...';

      try {
        const response = await fetch('/api/reviews/analyze-all-unreplied', { method: 'POST' });
        const data = await response.json();
        
        if (response.ok) {
          const message = `Analyzed ${data.analyzedCount || 0} reviews.\n\nGenerated ${data.generatedCount || 0} reply drafts.\nSkipped ${data.skippedCount || 0} (already analyzed).\n\nPlease review and approve replies before posting.`;
          showSuccess(message, 'Analysis Complete');
          loadReviews();
          loadStats();
        } else {
          showError(data.error || 'Failed to analyze reviews', 'Analysis Error');
        }
      } catch (error) {
        showError(error.message, 'Analysis Error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'ü§ñ Analyze All Unreplied';
      }
    }

    async function autoReplyUnreplied() {
      if (!confirm('This will automatically post replies to all Auto-Approved reviews from the last 6 months. Continue?')) {
        return;
      }

      const btn = event.target;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> Processing...';

      try {
        const response = await fetch('/api/reviews/auto-reply-unreplied', { method: 'POST' });
        const data = await response.json();
        
        if (response.ok) {
          const message = `Replied to ${data.successCount || 0} reviews.\nSkipped: ${data.skippedCount || 0} (already replied or needs approval)`;
          showSuccess(message, 'Auto-Reply Complete');
          loadReviews();
          loadStats();
        } else {
          showError(data.error || 'Failed to auto-reply', 'Auto-Reply Error');
        }
      } catch (error) {
        showError(error.message, 'Auto-Reply Error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '‚ö° Auto-Reply Approved';
      }
    }

    async function searchReview() {
      const author = document.getElementById('searchAuthor').value.trim();
      if (author.length < 2) {
        document.getElementById('searchResults').innerHTML = '';
        return;
      }

      try {
        const reviews = await fetch('/api/reviews').then(r => r.json());
        const matches = reviews.filter(r => 
          r.authorName.toLowerCase().includes(author.toLowerCase())
        ).slice(0, 5);

        const resultsEl = document.getElementById('searchResults');
        if (matches.length === 0) {
          resultsEl.innerHTML = '<p>No reviews found</p>';
          return;
        }

        resultsEl.innerHTML = matches.map(review => `
          <div class="review-item" onclick="selectReview(${review.id})">
            <strong>${review.authorName}</strong> - ${review.rating}‚≠ê (${new Date(review.createTime).toLocaleDateString()})
            ${review.comment ? '<div style="margin-top: 10px; color: #666;">' + review.comment.substring(0, 100) + '...</div>' : ''}
          </div>
        `).join('');
      } catch (error) {
        document.getElementById('searchResults').innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
      }
    }

    async function selectReview(reviewId) {
      try {
        const review = await fetch(`/api/reviews/${reviewId}`).then(r => r.json());
        currentReview = review;

        document.getElementById('reviewDetails').innerHTML = `
          <strong>Author:</strong> ${review.authorName}<br>
          <strong>Rating:</strong> ${'‚òÖ'.repeat(review.rating)}${'‚òÜ'.repeat(5 - review.rating)}<br>
          <strong>Date:</strong> ${new Date(review.createTime).toLocaleDateString()}<br>
          <strong>Comment:</strong> ${review.comment || '<em>No comment</em>'}
        `;

        const analysis = {
          sentiment: review.sentiment || 'Not analyzed',
          urgency: review.urgency || 'N/A',
          topics: review.topics || [],
          riskFlags: review.riskFlags || [],
        };

        document.getElementById('reviewAnalysis').innerHTML = `
          <div>
            <span class="badge badge-${analysis.sentiment === 'positive' ? 'success' : analysis.sentiment === 'negative' ? 'danger' : 'warning'}">${analysis.sentiment}</span>
            <span class="badge badge-info">${analysis.urgency} urgency</span>
          </div>
          ${analysis.topics.length > 0 ? `<div style="margin-top: 10px;"><strong>Topics:</strong> ${analysis.topics.join(', ')}</div>` : ''}
          ${analysis.riskFlags.length > 0 ? `<div style="margin-top: 10px;"><strong>Risk Flags:</strong> ${analysis.riskFlags.join(', ')}</div>` : ''}
        `;

        document.getElementById('replyDraft').value = review.replyDraft || '';
        document.getElementById('replyForm').style.display = 'block';
      } catch (error) {
        showError(`Error loading review: ${error.message}`, 'Error');
      }
    }

    async function generateReply() {
      if (!currentReview) {
        showWarning('Please select a review first', 'No Review Selected');
        return;
      }

      const btn = event.target;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> Generating...';

      try {
        const response = await fetch(`/api/reviews/${currentReview.id}/analyze`, { method: 'POST' });
        const data = await response.json();
        
        if (response.ok) {
          document.getElementById('replyDraft').value = data.replyDraft || '';
          currentReview = { ...currentReview, ...data };
          selectReview(currentReview.id); // Refresh display
          showSuccess('Reply generated successfully!', 'Reply Generated');
        } else {
          showError(data.error || 'Failed to generate reply', 'Generation Error');
        }
      } catch (error) {
        showError(error.message, 'Generation Error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'ü§ñ Generate AI Reply';
      }
    }

    async function saveReply() {
      if (!currentReview) {
        showWarning('Please select a review first', 'No Review Selected');
        return;
      }

      const replyDraft = document.getElementById('replyDraft').value;
      
      try {
        const response = await fetch(`/api/reviews/${currentReview.id}/reply`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ replyDraft }),
        });

        if (response.ok) {
          showSuccess('Reply draft saved!', 'Saved');
          loadReviews();
        } else {
          const data = await response.json();
          showError(data.error || 'Failed to save reply', 'Save Error');
        }
      } catch (error) {
        showError(error.message, 'Save Error');
      }
    }

    async function postReply() {
      if (!currentReview) {
        showWarning('Please select a review first', 'No Review Selected');
        return;
      }

      const replyDraft = document.getElementById('replyDraft').value;
      if (!replyDraft.trim()) {
        showWarning('Please enter a reply draft first', 'No Reply Draft');
        return;
      }

      if (!confirm(`Post this reply to ${currentReview.authorName}'s review?`)) {
        return;
      }

      const btn = event.target;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> Posting...';

      try {
        const response = await fetch(`/api/reviews/${currentReview.id}/post-reply`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ replyText: replyDraft }),
        });

        const data = await response.json();

        if (response.ok) {
          showSuccess('Reply posted successfully!', 'Posted');
          loadReviews();
          loadStats();
          document.getElementById('replyForm').style.display = 'none';
          document.getElementById('searchAuthor').value = '';
        } else {
          showError(data.error || 'Failed to post reply', 'Post Error');
        }
      } catch (error) {
        showError(error.message, 'Post Error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'üì§ Post Reply';
      }
    }

    async function postReplyById(reviewId) {
      const review = await fetch(`/api/reviews/${reviewId}`).then(r => r.json());
      
      if (!review.replyDraft) {
        showWarning('No reply draft found. Please generate a reply first.', 'No Draft');
        return;
      }

      if (!confirm(`Post this reply to ${review.authorName}'s review?`)) {
        return;
      }

      try {
        const response = await fetch(`/api/reviews/${reviewId}/post-reply`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ replyText: review.replyDraft }),
        });

        const data = await response.json();

        if (response.ok) {
          showSuccess('Reply posted successfully!', 'Posted');
          loadReviews();
          loadStats();
        } else {
          showError(data.error || 'Failed to post reply', 'Post Error');
        }
      } catch (error) {
        showError(error.message, 'Post Error');
      }
    }

    async function generateReplyForReview(reviewId) {
      const reviewItem = document.getElementById(`review-${reviewId}`);
      if (!reviewItem) return;

      const btn = event.target;
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> Generating...';

      try {
        const response = await fetch(`/api/reviews/${reviewId}/analyze`, { method: 'POST' });
        const data = await response.json();
        
        if (response.ok) {
          // Reload reviews to show the new reply draft
          loadReviews();
          showSuccess('Reply draft generated! Please review and edit if needed before posting.', 'Reply Generated');
        } else {
          showError(data.error || 'Failed to generate reply', 'Generation Error');
        }
      } catch (error) {
        showError(error.message, 'Generation Error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    async function regenerateReplyForReview(reviewId, clickEvent) {
      console.log('Regenerate clicked for review:', reviewId);
      
      // Find button - try multiple ways in case ID isn't set yet
      let btn = document.getElementById(`regenerateBtn-${reviewId}`);
      if (!btn && clickEvent && clickEvent.target) {
        // Try finding by event target
        btn = clickEvent.target.closest('button');
      }
      if (!btn) {
        showError('Could not find regenerate button', 'Error');
        console.error('Button not found for reviewId:', reviewId);
        return;
      }

      // Confirm regeneration
      if (!confirm('Regenerate the reply draft? This will replace the current draft with a new AI-generated reply.')) {
        return;
      }

      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> Regenerating...';

      // Show loading state on the draft text
      const draftEl = document.getElementById(`draft-${reviewId}`);
      const originalDraftText = draftEl ? draftEl.textContent : '';
      if (draftEl) {
        draftEl.innerHTML = '<em style="color: #999;">Regenerating reply...</em>';
      }

      try {
        console.log(`Calling /api/reviews/${reviewId}/analyze`);
        const response = await fetch(`/api/reviews/${reviewId}/analyze`, { 
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
        });
        
        const data = await response.json();
        console.log('Response:', response.ok, data);
        
        if (response.ok && data.replyDraft) {
          // Update the draft display immediately
          if (draftEl) {
            draftEl.textContent = data.replyDraft;
          }

          // Reload reviews to get updated status and analysis
          await loadReviews();
          showSuccess('Reply draft regenerated! Please review the new draft.', 'Reply Regenerated');
        } else {
          // Restore original draft on error
          if (draftEl && originalDraftText) {
            draftEl.textContent = originalDraftText;
          }
          showError(data.error || 'Failed to regenerate reply', 'Regeneration Error');
        }
      } catch (error) {
        console.error('Regenerate error:', error);
        // Restore original draft on error
        if (draftEl && originalDraftText) {
          draftEl.textContent = originalDraftText;
        }
        showError(error.message || 'Failed to regenerate reply', 'Regeneration Error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    async function editReply(reviewId) {
      // Close any existing edit modal first
      closeEditModal();

      // Get current review to fetch the draft
      const review = await fetch(`/api/reviews/${reviewId}`).then(r => r.json());
      const currentDraft = review.replyDraft || '';
      
      // Create backdrop/overlay
      const backdrop = document.createElement('div');
      backdrop.id = 'editModalBackdrop';
      backdrop.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 9999; animation: fadeIn 0.2s ease-out;';
      
      // Create modal container
      const editDiv = document.createElement('div');
      editDiv.id = 'editModalContainer';
      editDiv.setAttribute('data-review-id', reviewId);
      editDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 10000; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; animation: modalSlideIn 0.3s ease-out;';
      editDiv.innerHTML = `
        <h3 style="margin-bottom: 15px; margin-top: 0;">Edit Reply Draft</h3>
        <textarea id="editReplyText" style="width: 100%; min-height: 150px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-family: inherit; font-size: 1rem; resize: vertical;" placeholder="Enter reply text...">${currentDraft.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
        <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: flex-end;">
          <button class="btn btn-secondary" id="historyEditBtn" type="button">üïí History</button>
          <button class="btn btn-secondary" id="cancelEditBtn" type="button">Cancel</button>
          <button class="btn btn-success" id="saveEditBtn" type="button">üíæ Save Changes</button>
        </div>
      `;
      
      // Add event listeners
      const cancelBtn = editDiv.querySelector('#cancelEditBtn');
      const saveBtn = editDiv.querySelector('#saveEditBtn');
      const historyBtn = editDiv.querySelector('#historyEditBtn');
      
      cancelBtn.addEventListener('click', () => closeEditModal());
      saveBtn.addEventListener('click', () => saveEditedReply(reviewId));
      historyBtn.addEventListener('click', () => openHistory(reviewId));
      
      // Close on backdrop click
      backdrop.addEventListener('click', (e) => {
        if (e.target === backdrop) {
          closeEditModal();
        }
      });
      
      // Close on Escape key
      const escapeHandler = (e) => {
        if (e.key === 'Escape') {
          closeEditModal();
          document.removeEventListener('keydown', escapeHandler);
        }
      };
      document.addEventListener('keydown', escapeHandler);
      
      // Append to body
      document.body.appendChild(backdrop);
      document.body.appendChild(editDiv);
      
      // Focus the textarea
      setTimeout(() => {
        const textarea = document.getElementById('editReplyText');
        if (textarea) {
          textarea.focus();
          textarea.setSelectionRange(textarea.value.length, textarea.value.length);
        }
      }, 100);
    }

    function closeEditModal() {
      const backdrop = document.getElementById('editModalBackdrop');
      const modal = document.getElementById('editModalContainer');
      
      if (backdrop) {
        backdrop.style.animation = 'fadeOut 0.2s ease-out forwards';
        setTimeout(() => backdrop.remove(), 200);
      }
      
      if (modal) {
        modal.style.animation = 'modalSlideOut 0.2s ease-out forwards';
        setTimeout(() => modal.remove(), 200);
      }
    }

    async function saveEditedReply(reviewId) {
      // Get reviewId from modal if not provided
      if (!reviewId) {
        const modal = document.getElementById('editModalContainer');
        reviewId = modal ? modal.getAttribute('data-review-id') : null;
      }
      
      const textarea = document.getElementById('editReplyText');
      if (!textarea || !reviewId) {
        closeEditModal();
        return;
      }

      const newDraft = textarea.value.trim();
      if (newDraft === '') {
        showWarning('Reply cannot be empty', 'Validation Error');
        return;
      }

      // Disable buttons during save
      const saveBtn = document.getElementById('saveEditBtn');
      const cancelBtn = document.getElementById('cancelEditBtn');
      if (saveBtn) saveBtn.disabled = true;
      if (cancelBtn) cancelBtn.disabled = true;
      if (saveBtn) saveBtn.innerHTML = '<span class="loading"></span> Saving...';

      try {
        const response = await fetch(`/api/reviews/${reviewId}/reply`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ replyDraft: newDraft }),
        });

        if (response.ok) {
          // Close the modal
          closeEditModal();
          
          // Update the display
          const draftEl = document.getElementById(`draft-${reviewId}`);
          if (draftEl) {
            draftEl.textContent = newDraft;
          }
          
          // Reload to ensure consistency
          loadReviews();
          showSuccess('Reply draft updated!', 'Updated');
        } else {
          const data = await response.json();
          showError(data.error || 'Failed to update reply', 'Update Error');
          // Re-enable buttons on error
          if (saveBtn) saveBtn.disabled = false;
          if (cancelBtn) cancelBtn.disabled = false;
          if (saveBtn) saveBtn.innerHTML = 'üíæ Save Changes';
        }
      } catch (error) {
        showError(error.message, 'Update Error');
        // Re-enable buttons on error
        if (saveBtn) saveBtn.disabled = false;
        if (cancelBtn) cancelBtn.disabled = false;
        if (saveBtn) saveBtn.innerHTML = 'üíæ Save Changes';
      }
    }

    async function approveAndPost(reviewId) {
      if (!confirm('Approve this reply and post it to Google Business Profile?')) {
        return;
      }

      try {
        // First, update status to Auto-Approved
        await fetch(`/api/reviews/${reviewId}/reply`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'Auto-Approved' }),
        });

        // Then post the reply
        const review = await fetch(`/api/reviews/${reviewId}`).then(r => r.json());
        if (!review.replyDraft) {
          showWarning('No reply draft found', 'No Draft');
          return;
        }

        const response = await fetch(`/api/reviews/${reviewId}/post-reply`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ replyText: review.replyDraft }),
        });

        const data = await response.json();

        if (response.ok) {
          showSuccess('Reply approved and posted successfully!', 'Approved & Posted');
          loadReviews();
          loadStats();
        } else {
          showError(data.error || 'Failed to post reply', 'Post Error');
        }
      } catch (error) {
        showError(error.message, 'Post Error');
      }
    }

    async function generatePost() {
      const topic = document.getElementById('postTopic').value.trim();
      const postType = document.getElementById('postType').value;
      const callToAction = document.getElementById('postCTA').value;

      const btn = event.target;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> Generating...';

      try {
        const params = new URLSearchParams();
        if (topic) params.append('topic', topic);
        params.append('postType', postType);
        params.append('callToAction', callToAction);

        const response = await fetch(`/api/posts/generate?${params.toString()}`, { method: 'POST' });
        const data = await response.json();

        if (response.ok) {
          currentPost = data;
          document.getElementById('postContent').innerHTML = `
            <div style="margin-bottom: 15px;">
              <strong>Post Type:</strong> ${data.topicType}<br>
              <strong>Call-to-Action:</strong> ${data.callToAction?.actionType || 'None'}
            </div>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; white-space: pre-wrap;">${data.summary}</div>
            <div style="margin-top: 15px; color: #666;">
              Word Count: ${data.summary.split(/\s+/).length} words
            </div>
          `;

          if (data.imagePath) {
            document.getElementById('postImageInfo').innerHTML = `
              ‚úÖ Image generated: ${data.imagePath.split('/').pop()}
              <br><small>Note: Image will be uploaded to cloud storage before posting</small>
            `;
          }

          document.getElementById('postPreview').style.display = 'block';
        } else {
          showError(data.error || 'Failed to generate post', 'Post Generation Error');
        }
      } catch (error) {
        showError(error.message, 'Post Generation Error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'üé® Generate Post';
      }
    }

    async function confirmPost() {
      if (!currentPost) return;

      if (!confirm('Post this to Google My Business Profile?')) {
        return;
      }

      const btn = event.target;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> Posting...';

      try {
        const response = await fetch('/api/posts/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            summary: currentPost.summary,
            postType: currentPost.topicType,
            callToAction: currentPost.callToAction,
          }),
        });

        const data = await response.json();

        if (response.ok) {
          showSuccess('Post created successfully!', 'Posted to GMB');
          document.getElementById('postPreview').style.display = 'none';
          currentPost = null;
          listPosts();
        } else {
          showError(data.error || 'Failed to post', 'Post Error');
        }
      } catch (error) {
        showError(error.message, 'Post Error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '‚úÖ Post to GMB';
      }
    }

    function cancelPost() {
      document.getElementById('postPreview').style.display = 'none';
      currentPost = null;
    }

    async function listPosts() {
      try {
        const response = await fetch('/api/posts');
        const data = await response.json();

        const listEl = document.getElementById('postsList');
        
        // Handle different response formats - ensure posts is always an array
        let posts = [];
        if (data && Array.isArray(data)) {
          posts = data;
        } else if (data && Array.isArray(data.posts)) {
          posts = data.posts;
        } else if (data && data.posts && !Array.isArray(data.posts)) {
          // If posts is a single object, wrap it in an array
          posts = [data.posts];
        } else if (data && data.localPosts && Array.isArray(data.localPosts)) {
          posts = data.localPosts;
        }
        
        if (!posts || posts.length === 0) {
          listEl.innerHTML = '<div class="empty-state"><p>No posts found</p></div>';
          return;
        }

        listEl.innerHTML = `
          <h3 style="margin-bottom: 20px;">Recent Posts (${posts.length})</h3>
          ${posts.map(post => `
            <div class="card">
              <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <strong>${post.state || post.status || 'Unknown'}</strong>
                <span style="color: #666;">${new Date(post.createTime || post.updateTime || Date.now()).toLocaleDateString()}</span>
              </div>
              <div style="color: #555;">${post.summary || post.content || 'No summary'}</div>
            </div>
          `).join('')}
        `;
      } catch (error) {
        const listEl = document.getElementById('postsList');
        listEl.innerHTML = `<div class="alert alert-error">Error loading posts: ${error.message}</div>`;
        console.error('Error loading posts:', error);
      }
    }

    async function researchKeywords() {
      const location = document.getElementById('trendLocation').value.trim();
      const radius = parseInt(document.getElementById('trendRadius').value) || 10;
      const businessName = document.getElementById('rankingBusinessName')?.value?.trim() || '';
      const websiteDomain = document.getElementById('rankingWebsiteDomain')?.value?.trim() || '';
      const useSerpApi = !!document.getElementById('useSerpApiRankings')?.checked;

      if (!location) {
        showWarning('Please enter a location', 'Location Required');
        return;
      }

      const btn = event.target;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> Researching...';

      try {
        const response = await fetch('/api/keywords/research', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ location, radius, businessName, websiteDomain, includeRankings: useSerpApi }),
        });

        const data = await response.json();

        if (response.ok) {
          const rankings = Array.isArray(data.rankings) ? data.rankings : [];
          const rankingByKeyword = new Map(rankings.map(r => [r.keyword, r]));

          document.getElementById('trendsResults').innerHTML = `
            <div class="alert alert-success">
              ‚úÖ Keyword research complete! Found ${data.keywordsCount || 0} keywords.
            </div>
            <div class="card">
              <h3>Top Keywords</h3>
              <div class="keyword-list">
                ${(data.topKeywords || []).map(kw => {
                  const keyword = kw.keyword || kw;
                  const r = rankingByKeyword.get(keyword);
                  const gmb = r && typeof r.gmbRank === 'number' ? `#${r.gmbRank}` : '‚Äî';
                  const web = r && typeof r.websiteRank === 'number' ? `#${r.websiteRank}` : '‚Äî';
                  const provider = r?.provider ? String(r.provider) : 'none';

                  return `
                  <div class="keyword-item">
                    <strong>${keyword}</strong>
                    <span style="color:#666;">GBP Rank: <strong>${gmb}</strong></span>
                    <span style="color:#666;">Website Rank: <strong>${web}</strong></span>
                    <span style="color:#999; font-size: 0.85rem;">Source: ${provider}</span>
                    ${kw.volume ? `<span>Volume: ${kw.volume}</span>` : ''}
                    ${kw.trend ? `<span>Trend: ${kw.trend}</span>` : ''}
                  </div>
                `;
                }).join('')}
              </div>
            </div>
          `;
        } else {
          showError(data.error || 'Failed to research keywords', 'Keyword Research Error');
        }
      } catch (error) {
        showError(error.message, 'Keyword Research Error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'üîç Research Keywords';
      }
    }

    async function loadRankingDefaults() {
      try {
        const res = await fetch('/api/keywords/research-defaults');
        const data = await res.json();
        if (!res.ok || !data?.success) return;

        const nameEl = document.getElementById('rankingBusinessName');
        const domainEl = document.getElementById('rankingWebsiteDomain');
        if (nameEl && !nameEl.value) nameEl.value = data.defaultBusinessName || '';
        if (domainEl && !domainEl.value) domainEl.value = data.defaultWebsiteDomain || '';
      } catch (e) {
        // non-fatal
      }
    }

    async function generateWeeklyReport() {
      const location = document.getElementById('reportLocation').value.trim();

      const btn = event.target;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> Generating...';

      try {
        const response = await fetch('/api/keywords/weekly-report', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ location: location || null }),
        });

        const data = await response.json();

        if (response.ok) {
          showSuccess('Weekly report generated successfully!', 'Report Generated');
          viewTrends();
        } else {
          showError(data.error || 'Failed to generate report', 'Report Generation Error');
        }
      } catch (error) {
        showError(error.message, 'Report Generation Error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'üìä Generate Weekly Report';
      }
    }

    async function viewTrends() {
      try {
        const response = await fetch('/api/keywords/trends');
        const data = await response.json();

        const resultsEl = document.getElementById('trendsResults');
        if (!data || !data.topKeywords) {
          resultsEl.innerHTML = '<div class="alert alert-info">No trends available. Generate a weekly report first.</div>';
          return;
        }

        // Parse keywords if they're strings, otherwise use as-is (already arrays)
        let topKeywords = data.topKeywords;
        if (typeof topKeywords === 'string') {
          topKeywords = JSON.parse(topKeywords);
        }
        
        let trendingUp = data.trendingUp;
        if (trendingUp && typeof trendingUp === 'string') {
          trendingUp = JSON.parse(trendingUp);
        }
        
        let trendingDown = data.trendingDown;
        if (trendingDown && typeof trendingDown === 'string') {
          trendingDown = JSON.parse(trendingDown);
        }

        // Ensure they're arrays
        if (!Array.isArray(topKeywords)) {
          topKeywords = [];
        }
        if (!Array.isArray(trendingUp)) {
          trendingUp = [];
        }
        if (!Array.isArray(trendingDown)) {
          trendingDown = [];
        }

        resultsEl.innerHTML = `
          <div class="card">
            <h3>Latest Weekly Report</h3>
            <p><strong>Date:</strong> ${new Date(data.reportDate).toLocaleDateString()}</p>
            <p><strong>Location:</strong> ${data.location || 'All Locations'}</p>
          </div>
          <div class="card">
            <h3>Top Keywords</h3>
            <div class="keyword-list">
              ${topKeywords.slice(0, 20).map((kw, i) => `
                <div class="keyword-item">
                  <strong>#${i + 1} ${typeof kw === 'string' ? kw : kw.keyword || kw}</strong>
                  ${typeof kw === 'object' && kw.volume ? `<span>Volume: ${kw.volume}</span>` : ''}
                </div>
              `).join('')}
            </div>
          </div>
          ${trendingUp && trendingUp.length > 0 ? `
            <div class="card">
              <h3>Trending Up</h3>
              <div class="keyword-list">
                ${trendingUp.slice(0, 10).map((kw, i) => `
                  <div class="keyword-item">
                    <strong>${typeof kw === 'string' ? kw : kw.keyword || kw}</strong>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
          ${data.summary ? `
            <div class="card">
              <h3>AI Summary</h3>
              <div style="white-space: pre-wrap; color: #555;">${data.summary}</div>
            </div>
          ` : ''}
        `;
      } catch (error) {
        document.getElementById('trendsResults').innerHTML = `<div class="alert alert-error">Error loading trends: ${error.message}</div>`;
      }
    }

    // OAuth Connection Functions
    async function checkGoogleConnection() {
      try {
        const response = await fetch('/api/auth/google/status');
        const status = await response.json();
        
        const statusEl = document.getElementById('googleConnectionStatus');
        const connectBtn = document.getElementById('connectGoogleBtn');
        const disconnectBtn = document.getElementById('disconnectGoogleBtn');
        
        if (statusEl && connectBtn && disconnectBtn) {
          if (status.connected) {
            statusEl.innerHTML = '<span class="badge badge-success">‚úì Connected</span>';
            connectBtn.style.display = 'none';
            disconnectBtn.style.display = 'inline-block';
          } else {
            statusEl.innerHTML = '<span class="badge badge-danger">‚úó Not Connected</span>';
            connectBtn.style.display = 'inline-block';
            disconnectBtn.style.display = 'none';
          }
        }
      } catch (error) {
        console.error('Failed to check Google connection:', error);
        const statusEl = document.getElementById('googleConnectionStatus');
        if (statusEl) {
          statusEl.innerHTML = '<span class="badge badge-danger">‚úó Connection check failed</span>';
        }
      }
    }

    function connectGoogle() {
      // Keep this for any legacy onClick bindings; the primary button is now an <a href="...">
      try {
        showInfo('Redirecting to Google sign-in...', 'Connecting');
      } catch (_) {}
      window.location.href = '/api/auth/google/connect';
    }

    async function disconnectGoogle() {
      if (!confirm('Are you sure you want to disconnect Google Business Profile? This will stop automatic review fetching.')) {
        return;
      }

      try {
        const response = await fetch('/api/auth/google/disconnect', { method: 'POST' });
        const data = await response.json();
        
        if (response.ok) {
          showSuccess('Google Business Profile disconnected successfully', 'Disconnected');
          checkGoogleConnection();
        } else {
          showError(data.error || 'Failed to disconnect', 'Disconnect Error');
        }
      } catch (error) {
        showError(error.message || 'Failed to disconnect', 'Disconnect Error');
      }
    }

    function handleOAuthCallback() {
      const urlParams = new URLSearchParams(window.location.search);
      
      // Handle OAuth success
      if (urlParams.get('oauth_success')) {
        showSuccess('Google Business Profile connected successfully! You can now fetch reviews.', 'Connected');
        // Clean URL
        window.history.replaceState({}, document.title, window.location.pathname);
        // Refresh connection status
        checkGoogleConnection();
      }
      
      // Handle OAuth errors
      if (urlParams.get('oauth_error')) {
        const error = urlParams.get('oauth_error');
        let errorMessage = 'Failed to connect Google Business Profile';
        
        // Provide user-friendly error messages
        if (error === 'no_refresh_token') {
          errorMessage = 'No refresh token received. Please try again. If this persists, check your OAuth configuration.';
        } else if (error === 'no_code') {
          errorMessage = 'No authorization code received. Please try connecting again.';
        } else if (error === 'invalid_grant') {
          errorMessage = 'Authorization failed. Your refresh token may be expired. Please try connecting again.';
        } else if (error === 'redirect_uri_mismatch') {
          errorMessage = 'Redirect URI mismatch. Please check your GOOGLE_REDIRECT_URI in .env matches your Google Cloud Console settings (should be: http://localhost:3000/api/auth/google/callback)';
        } else {
          errorMessage = `Connection failed: ${error}`;
        }
        
        showError(errorMessage, 'Connection Error');
        // Clean URL
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    }

    async function analyzeProfile(event) {
      const btn = event.target;
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> Analyzing...';

      try {
        const response = await fetch('/api/analysis/profile');
        const analysis = await response.json();

        if (response.ok) {
          const resultsEl = document.getElementById('analysisResults');
          resultsEl.innerHTML = `
            <div class="analysis-result">
              <div class="score-circle">${analysis.overallScore}/100</div>
              <h2 style="text-align: center; margin-bottom: 30px;">Overall Profile Score</h2>

              <div class="card">
                <h3>‚úÖ Strengths</h3>
                <ul>
                  ${analysis.strengths.map(s => `<li>${s}</li>`).join('')}
                </ul>
              </div>

              <div class="card">
                <h3>‚ö†Ô∏è Weaknesses</h3>
                <ul>
                  ${analysis.weaknesses.map(w => `<li>${w}</li>`).join('')}
                </ul>
              </div>

              <div class="card">
                <h3>üí° Recommendations</h3>
                ${Array.isArray(analysis.recommendations?.highPriority) ? `
                  <div style="margin-bottom: 20px;">
                    <h4 style="color: #dc3545; margin-bottom: 10px;">üî¥ High Priority</h4>
                    ${analysis.recommendations.highPriority.map(rec => `<div class="recommendation-item high"><p>${rec}</p></div>`).join('')}
                  </div>
                ` : ''}
                ${Array.isArray(analysis.recommendations?.mediumPriority) ? `
                  <div style="margin-bottom: 20px;">
                    <h4 style="color: #ffc107; margin-bottom: 10px;">üü° Medium Priority</h4>
                    ${analysis.recommendations.mediumPriority.map(rec => `<div class="recommendation-item medium"><p>${rec}</p></div>`).join('')}
                  </div>
                ` : ''}
                ${Array.isArray(analysis.recommendations?.lowPriority) ? `
                  <div style="margin-bottom: 20px;">
                    <h4 style="color: #28a745; margin-bottom: 10px;">üü¢ Low Priority</h4>
                    ${analysis.recommendations.lowPriority.map(rec => `<div class="recommendation-item low"><p>${rec}</p></div>`).join('')}
                  </div>
                ` : ''}
              </div>

              <div class="card">
                <h3>üìà Trend Analysis</h3>
                <div style="white-space: pre-wrap; color: #555;">${analysis.trendAnalysis}</div>
              </div>

              <div class="card">
                <h3>üöÄ Growth Opportunities</h3>
                <ul>
                  ${analysis.growthOpportunities.map(opp => `<li>${opp}</li>`).join('')}
                </ul>
              </div>

              <div class="card">
                <h3>üìã Executive Summary</h3>
                <div style="white-space: pre-wrap; color: #555;">${analysis.executiveSummary || analysis.summary || 'No summary available'}</div>
              </div>
            </div>
          `;
        } else {
          showError(analysis.error || 'Failed to analyze profile', 'Analysis Error');
        }
      } catch (error) {
        showError(error.message, 'Analysis Error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'üîç Analyze Profile';
      }
    }
    </script>
  </body>
</html>
